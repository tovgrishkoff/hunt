# üöÄ Smart Joiner - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

`SmartJoiner` - –º–æ–¥—É–ª—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ Telegram-–≥—Ä—É–ø–ø—ã —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π FloodWait –∏ —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–∏–≤—è–∑–∫–æ–π –≥—Ä—É–ø–ø –∫ –∞–∫–∫–∞—É–Ω—Ç–∞–º.

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

1. **–ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 3-5 –≥—Ä—É–ø–ø –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫
2. **–£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ FloodWait**:
   - **‚â§600 —Å–µ–∫ (10 –º–∏–Ω)**: –ñ–¥–µ–º –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≥—Ä—É–ø–ø—É
   - **>600 —Å–µ–∫**: –ü–æ–º–µ—á–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç –∫–∞–∫ `cooldown`, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π –∞–∫–∫–∞—É–Ω—Ç
3. **–°—Ç—Ä–æ–≥–∞—è –ø—Ä–∏–≤—è–∑–∫–∞**: –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–∞ –∂–µ—Å—Ç–∫–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –∞–∫–∫–∞—É–Ω—Ç—É
4. **Warm-up –ø–µ—Ä–∏–æ–¥**: 24 —á–∞—Å–∞ –ø–æ—Å–ª–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è (—á–µ—Ä–µ–∑ `warmup_ends_at`)
5. **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–∞—É–∑—ã**: 5-10 –º–∏–Ω—É—Ç –º–µ–∂–¥—É —É—Å–ø–µ—à–Ω—ã–º–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è–º–∏, 60 —Å–µ–∫ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- `lexus_db` - –º–æ–¥—É–ª—å —Ä–∞–±–æ—Ç—ã —Å –ë–î
- `telethon` - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è Telegram API

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from services.account-manager.smart_joiner import SmartJoiner
import asyncio

async def main():
    joiner = SmartJoiner()
    await joiner.run_batch(niche='ukraine_cars', batch_size=5)

asyncio.run(main())
```

### –ó–∞–ø—É—Å–∫ –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

```bash
# –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: niche='ukraine_cars', batch_size=5)
python3 services/account-manager/smart_joiner.py

# –° —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∏—à–∏
python3 services/account-manager/smart_joiner.py ukraine_cars

# –° —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∏—à–∏ –∏ —Ä–∞–∑–º–µ—Ä–∞ –±–∞—Ç—á–∞
python3 services/account-manager/smart_joiner.py ukraine_cars 5
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Cron/Docker

```bash
# –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
0 */2 * * * cd /app && python3 services/account-manager/smart_joiner.py ukraine_cars 5
```

## üìä –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (Batch Fetching)

–í—ã–±–∏—Ä–∞–µ—Ç –∏–∑ –ë–î –≥—Ä—É–ø–ø—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `'new'` –∏ —É–∫–∞–∑–∞–Ω–Ω–æ–π –Ω–∏—à–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `'ukraine_cars'`):

```sql
SELECT * FROM targets
WHERE status = 'new' AND niche = 'ukraine_cars'
LIMIT 5;
```

### 2. –¶–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã)

1. **–í—ã–±–æ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞**: –í—ã–±–∏—Ä–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç (`status='active'`, `next_allowed_action_time < NOW()`)
2. **–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞**: –°–æ–∑–¥–∞–µ—Ç `TelegramClient` –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
3. **–ü–æ–ø—ã—Ç–∫–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è**: –í—ã–∑—ã–≤–∞–µ—Ç `JoinChannelRequest`

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

#### –£—Å–ø–µ—à–Ω–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ ‚úÖ

1. –û–±–Ω–æ–≤–ª—è–µ—Ç –ë–î —á–µ—Ä–µ–∑ `DbManager.assign_group()`:
   - `status = 'joined'`
   - `assigned_account_id = account.id` (–∂–µ—Å—Ç–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞!)
   - `joined_at = NOW()`
   - `warmup_ends_at = NOW() + 24 —á–∞—Å–∞`
2. –õ–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—Ö
3. **–ü–∞—É–∑–∞ 5-10 –º–∏–Ω—É—Ç** –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –≥—Ä—É–ø–ø–æ–π

#### –û—à–∏–±–∫–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è ‚ùå

1. –û–±–Ω–æ–≤–ª—è–µ—Ç –ë–î:
   - `status = 'error'`
   - `error_message = '...'`
2. **–ü–∞—É–∑–∞ 60 —Å–µ–∫—É–Ω–¥** –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –≥—Ä—É–ø–ø–æ–π

#### FloodWait ‚è≥

**–ï—Å–ª–∏ `e.seconds <= 600` (10 –º–∏–Ω—É—Ç):**
1. –õ–æ–≥–∏—Ä—É–µ—Ç: "–ñ–¥–µ–º {e.seconds} —Å–µ–∫..."
2. `await asyncio.sleep(e.seconds)`
3. –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –≥—Ä—É–ø–ø—É, –±–µ—Ä–µ—Ç —Å–ª–µ–¥—É—é—â—É—é

**–ï—Å–ª–∏ `e.seconds > 600` (10 –º–∏–Ω—É—Ç):**
1. –û–±–Ω–æ–≤–ª—è–µ—Ç –∞–∫–∫–∞—É–Ω—Ç –≤ –ë–î:
   - `status = 'cooldown'`
   - `next_allowed_action_time = NOW() + e.seconds`
2. –î–æ–±–∞–≤–ª—è–µ—Ç –∞–∫–∫–∞—É–Ω—Ç –≤ `excluded_account_ids`
3. –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –≥—Ä—É–ø–ø—É, –ø—Ä–æ–±—É–µ—Ç **–¥—Ä—É–≥–æ–π** –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

–ú–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏:

- **`accounts`**: –ê–∫–∫–∞—É–Ω—Ç—ã
  - `status`: 'active', 'banned', 'flood_wait', 'cooldown'
  - `next_allowed_action_time`: –ö–æ–≥–¥–∞ –∞–∫–∫–∞—É–Ω—Ç —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–µ–Ω
  
- **`targets`**: –ì—Ä—É–ø–ø—ã
  - `status`: 'new', 'joined', 'error', 'banned'
  - `assigned_account_id`: ID –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (FK)
  - `joined_at`: –í—Ä–µ–º—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
  - `warmup_ends_at`: –û–∫–æ–Ω—á–∞–Ω–∏–µ warm-up (joined_at + 24h)
  - `error_message`: –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ status='error')

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤:
- **–§–∞–π–ª**: `logs/smart_joiner.log`
- **–ö–æ–Ω—Å–æ–ª—å**: stdout

–§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤:
```
2026-01-12 10:00:00 - INFO - üöÄ SMART JOINER - –ë–ê–¢–ß –í–°–¢–£–ü–õ–ï–ù–ò–ô
2026-01-12 10:00:01 - INFO - üìã [1/5] –ì—Ä—É–ø–ø–∞: @autobazar_com_ua
2026-01-12 10:00:02 - INFO -   üë§ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫–∫–∞—É–Ω—Ç: promotion_dao_bro (id=1)
2026-01-12 10:00:05 - INFO -   ‚úÖ –í—Å—Ç—É–ø–∏–ª –≤ @autobazar_com_ua
2026-01-12 10:00:05 - INFO -   ‚úÖ –ì—Ä—É–ø–ø–∞ @autobazar_com_ua –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∞–∫–∫–∞—É–Ω—Ç—É promotion_dao_bro
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —á—Ç–æ –∏ `lexus_db`:
- `DATABASE_URL` - URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
- –ò–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ: `POSTGRES_HOST`, `POSTGRES_PORT`, `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤

–§–∞–π–ª `accounts_config.json` –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –ø–æ–ª—è–º–∏:
```json
[
  {
    "session_name": "promotion_dao_bro",
    "api_id": 12345678,
    "api_hash": "abcdef1234567890",
    "string_session": "...",
    "proxy": "socks5://user:pass@host:port"
  }
]
```

## üîç –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ó–∞–ø—É—Å–∫ –±–∞—Ç—á–∞

```python
import asyncio
from services.account-manager.smart_joiner import SmartJoiner

async def run_joiner():
    joiner = SmartJoiner(accounts_config_path='accounts_config.json')
    await joiner.run_batch(niche='ukraine_cars', batch_size=5)

asyncio.run(run_joiner())
```

### –ü—Ä–∏–º–µ—Ä 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

```python
# –í –≤–∞—à–µ–º scheduler.py –∏–ª–∏ cron job
from services.account-manager.smart_joiner import SmartJoiner

async def scheduled_join_task():
    joiner = SmartJoiner()
    await joiner.run_batch(niche='ukraine_cars', batch_size=5)
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–û–¥–∏–Ω –∑–∞–ø—É—Å–∫ = –æ–¥–∏–Ω –±–∞—Ç—á**: –°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–∞—Ç—á –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è (–¥–ª—è Cron/Docker)
2. **–°—Ç—Ä–æ–≥–∞—è –ø—Ä–∏–≤—è–∑–∫–∞**: –ì—Ä—É–ø–ø–∞ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –∞–∫–∫–∞—É–Ω—Ç—É –Ω–∞–≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
3. **Warm-up**: –ü–æ—Å–ª–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –ø–æ—Å—Ç–∏–Ω–≥–∞ 24 —á–∞—Å–∞ (`warmup_ends_at`)
4. **FloodWait >600 —Å–µ–∫**: –ê–∫–∫–∞—É–Ω—Ç –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ `cooldown` –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–æ `next_allowed_action_time`
5. **–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞**: –°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏–∫—É)

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–±–ª–µ–º–∞: "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤"

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ë–î:
```sql
SELECT id, session_name, status, next_allowed_action_time
FROM accounts
WHERE status = 'active';
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Account config not found"

**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `accounts_config.json` —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø–∏—Å—å —Å `session_name`, –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –≤ –ë–î.

### –ü—Ä–æ–±–ª–µ–º–∞: "Failed to create client"

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `api_id`, `api_hash`, `string_session`
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç–∞

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏

- `lexus_db/db_manager.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä –ë–î —Å –º–µ—Ç–æ–¥–æ–º `assign_group()`
- `lexus_db/models.py` - –ú–æ–¥–µ–ª–∏ –ë–î (Account, Target)
- `services/account-manager/joiner.py` - –°—Ç–∞—Ä—ã–π –º–æ–¥—É–ª—å –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)
