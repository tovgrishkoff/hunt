#!/usr/bin/env python3
"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–¥–∞—é—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ChatGPT API
"""

import os
import asyncio
import logging
from typing import Optional
from pathlib import Path

logger = logging.getLogger(__name__)

# –ó–∞–≥—Ä—É–∂–∞–µ–º .env —Ñ–∞–π–ª, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
def load_env_file():
    """–ü—Ä–æ—Å—Ç–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ .env —Ñ–∞–π–ª–∞"""
    env_file = Path(__file__).parent / '.env'
    if env_file.exists():
        try:
            with open(env_file, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#') and '=' in line:
                        key, value = line.split('=', 1)
                        os.environ[key.strip()] = value.strip()
        except Exception as e:
            logging.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å .env —Ñ–∞–π–ª: {e}")

# –ó–∞–≥—Ä—É–∂–∞–µ–º .env –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è
load_env_file()

# –ü—Ä–æ–±—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å OpenAI, –µ—Å–ª–∏ –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback —á–µ—Ä–µ–∑ aiohttp
try:
    from openai import AsyncOpenAI
    HAS_OPENAI_LIB = True
except ImportError:
    HAS_OPENAI_LIB = False
    import aiohttp


class ChatGPTResponseGenerator:
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–¥–∞—é—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ ChatGPT API"""
    
    def __init__(self, api_key: Optional[str] = None, api_base: Optional[str] = None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤
        
        Args:
            api_key: OpenAI API –∫–ª—é—á (–º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENAI_API_KEY)
            api_base: –ë–∞–∑–æ–≤—ã–π URL API (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∫—Å–∏)
        """
        self.api_key = api_key or os.getenv('OPENAI_API_KEY')
        self.api_base = api_base or os.getenv('OPENAI_API_BASE')
        self.enabled = bool(self.api_key)
        
        if not self.enabled:
            logger.warning("‚ö†Ô∏è ChatGPT API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–Ω–µ—Ç OPENAI_API_KEY). –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è fallback.")
        else:
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç OpenAI, –µ—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
            if HAS_OPENAI_LIB:
                try:
                    # –ü—Ä–æ—Å—Ç–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å api_key
                    # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω base_url, –æ–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
                    self.client = AsyncOpenAI(api_key=self.api_key)
                    logger.info("‚úÖ OpenAI –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenAI –∫–ª–∏–µ–Ω—Ç–∞: {e}")
                    self.client = None
            else:
                self.client = None
                logger.warning("‚ö†Ô∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ openai –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è aiohttp")
        
        # –ë–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –º—ã –ø—Ä–æ–¥–∞–µ–º
        self.bot_username = "@Lead_Hunbot"
        
    async def generate_selling_response(
        self, 
        incoming_message: str,
        service_type: str = "default",
        max_retries: int = 2
    ) -> Optional[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–¥–∞—é—â–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        
        Args:
            incoming_message: –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            service_type: –¢–∏–ø —É—Å–ª—É–≥–∏ (photo_video, real_estate, beauty, transport, tourism, default)
            max_retries: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        
        Returns:
            –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        if not self.enabled:
            return None
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–¥–∞—é—â–∏–π –ø—Ä–æ–º–ø—Ç
        prompt = self._create_selling_prompt(incoming_message, service_type)
        
        # –ü—ã—Ç–∞–µ–º—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
        for attempt in range(max_retries):
            try:
                response = await self._call_chatgpt_api(prompt)
                if response:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–æ—Ç–∞
                    if self.bot_username.lower() not in response.lower():
                        logger.warning(f"‚ö†Ô∏è –û—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–æ—Ç–∞, –¥–æ–±–∞–≤–ª—è—é...")
                        # –î–æ–±–∞–≤–ª—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–æ—Ç–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                        if not response.endswith('.'):
                            response += '.'
                        response += f" –ö—Å—Ç–∞—Ç–∏, –æ—á–µ–Ω—å —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å {self.bot_username}!"
                    return response
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1} –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}")
                if attempt < max_retries - 1:
                    await asyncio.sleep(1)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º
        
        logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ ChatGPT –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫")
        return None
    
    def _create_selling_prompt(self, incoming_message: str, service_type: str) -> str:
        """
        –°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–¥–∞—é—â–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è ChatGPT
        """
        service_context = self._get_service_context(service_type)
        
        # –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞ (70% —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é, 30% –ø—Ä–æ—Å—Ç–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ)
        import random
        include_call_to_action = random.random() < 0.7  # 70% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
        
        call_to_action_text = ""
        if include_call_to_action:
            call_to_action_options = [
                f"–ü–µ—Ä–µ—Ö–æ–¥–∏ –≤ {self.bot_username} –∏ –ø–æ–ø—Ä–æ–±—É–π - –Ω–µ –ø–æ–∂–∞–ª–µ–µ—à—å!",
                f"–ó–∞—Ö–æ–¥–∏ –≤ {self.bot_username}, —Ç–∞–º —Ä–µ–∞–ª—å–Ω–æ –Ω–∞—Ö–æ–¥—è—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç!",
                f"–ü—Ä–æ–≤–µ—Ä—å {self.bot_username}, –º–æ–∂–µ—Ç –∏ —Ç–µ–±–µ –ø–æ–¥–æ–π–¥–µ—Ç",
                f"–ü–æ–ø—Ä–æ–±—É–π {self.bot_username} - —Ç–∞–º –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –º–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤",
                f"–ó–∞–≥–ª—è–Ω–∏ –≤ {self.bot_username}, –æ—á–µ–Ω—å —Ä–µ–∫–æ–º–µ–Ω–¥—É—é!"
            ]
            call_to_action_text = f"\n6. –í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –î–û–ë–ê–í–¨ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (–≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤–ø–∏—à–∏ –≤ —Ç–µ–∫—Å—Ç):\n{chr(10).join('   - ' + opt for opt in call_to_action_options)}\n\n–í–ê–ñ–ù–û: –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º —Ç–µ–∫—Å—Ç–∞, –Ω–µ –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º."
        
        prompt = f"""–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–¥–∞–≤–∞—Ç—å Telegram-–±–æ—Ç–∞ {self.bot_username} —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

–ö–æ–Ω—Ç–µ–∫—Å—Ç:
- –¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–ª–æ–∂–∏–ª —Å–≤–æ—é —É—Å–ª—É–≥—É
- –¢—ã –ù–ï –ø–æ–∫—É–ø–∞–µ—à—å —É—Å–ª—É–≥—É, –∞ –º—è–≥–∫–æ –ø—Ä–æ–¥–∞–µ—à—å –±–æ—Ç–∞ {self.bot_username}
- –ë–æ—Ç –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞/—É—Å–ª—É–≥
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –∏ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤—ã–º
- –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–º–∞–∫—Å–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤)
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º—è–Ω–∏ {self.bot_username} –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º

–¢–∏–ø —É—Å–ª—É–≥–∏ –∫–ª–∏–µ–Ω—Ç–∞: {service_context}

–í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:
"{incoming_message}"

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å –∑–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ –≤—ã—Ä–∞–∑–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å
2. –ú—è–≥–∫–æ —Å–ø—Ä–æ—Å–∏—Ç—å, –∫–∞–∫ –æ–Ω–∏ –Ω–∞—Ö–æ–¥—è—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ (–∏–ª–∏ —É–ø–æ–º—è–Ω—É—Ç—å —ç—Ç—É —Ç–µ–º—É)
3. –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ {self.bot_username} –∏ –µ–≥–æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö –¥–ª—è –∏—Ö —Ç–∏–ø–∞ —É—Å–ª—É–≥
4. –ü—Ä–∏–≤–µ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–Ω–æ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π, –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ —Ç–∏–ø–∞ "–ø–æ–º–æ–≥ –Ω–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤")
5. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å{call_to_action_text}

–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ë–ï–ó –ø—Ä–∏–∑—ã–≤–∞ (–ù–ï –∫–æ–ø–∏—Ä—É–π, —Å–æ–∑–¥–∞–π —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π):
"–ü—Ä–∏–≤–µ—Ç! –°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ! –ö—Å—Ç–∞—Ç–∏, –∞ –∫–∞–∫ —Ç—ã –æ–±—ã—á–Ω–æ –Ω–∞—Ö–æ–¥–∏—à—å –∫–ª–∏–µ–Ω—Ç–æ–≤? –Ø –Ω–µ–¥–∞–≤–Ω–æ –Ω–∞—á–∞–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å {self.bot_username} - –æ—á–µ–Ω—å –ø–æ–º–æ–≥–∞–µ—Ç –≤ –ø–æ–∏—Å–∫–µ –∑–∞–∫–∞–∑—á–∏–∫–æ–≤ –≤ —Ç–≤–æ–µ–π –Ω–∏—à–µ. –ó–∞ –º–µ—Å—è—Ü –ø–æ–ª—É—á–∏–ª –±–æ–ª—å—à–µ –∑–∞–∫–∞–∑–æ–≤, —á–µ–º —Ä–∞–Ω—å—à–µ –∑–∞ –ø–æ–ª–≥–æ–¥–∞."

–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –° –ø—Ä–∏–∑—ã–≤–æ–º (–ù–ï –∫–æ–ø–∏—Ä—É–π, —Å–æ–∑–¥–∞–π —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π):
"–ü—Ä–∏–≤–µ—Ç! –°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ! –ö—Å—Ç–∞—Ç–∏, –∞ –∫–∞–∫ —Ç—ã –æ–±—ã—á–Ω–æ –Ω–∞—Ö–æ–¥–∏—à—å –∫–ª–∏–µ–Ω—Ç–æ–≤? –Ø –Ω–µ–¥–∞–≤–Ω–æ –Ω–∞—á–∞–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å {self.bot_username} - –æ—á–µ–Ω—å –ø–æ–º–æ–≥–∞–µ—Ç –≤ –ø–æ–∏—Å–∫–µ –∑–∞–∫–∞–∑—á–∏–∫–æ–≤ –≤ —Ç–≤–æ–µ–π –Ω–∏—à–µ. –ó–∞ –º–µ—Å—è—Ü –ø–æ–ª—É—á–∏–ª –±–æ–ª—å—à–µ –∑–∞–∫–∞–∑–æ–≤, —á–µ–º —Ä–∞–Ω—å—à–µ –∑–∞ –ø–æ–ª–≥–æ–¥–∞. –ó–∞—Ö–æ–¥–∏ –≤ {self.bot_username}, —Ç–∞–º —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç!"

–í–∞–∂–Ω–æ:
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –∫–∞–∫ –≤ –ª–∏—á–Ω–æ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã, —Å–¥–µ–ª–∞–π –æ—Ç–≤–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–º
- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å
- –ù–µ –ø–µ—Ä–µ–±–æ—Ä—â–∏ —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏ - –±—É–¥—å –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤—ã–º
- –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—à—å –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é, —Å–¥–µ–ª–∞–π –µ–≥–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º —Ç–µ–∫—Å—Ç–∞

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç:"""
        
        return prompt
    
    def _get_service_context(self, service_type: str) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ç–∏–ø–∞ —É—Å–ª—É–≥–∏"""
        contexts = {
            'photo_video': '—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ/–≤–∏–¥–µ–æ–≥—Ä–∞—Ñ (—Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏, —Å—ä–µ–º–∫–∏, –º–æ–Ω—Ç–∞–∂)',
            'real_estate': '—Ä–∏–µ–ª—Ç–æ—Ä/–∞–≥–µ–Ω—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ (–ø—Ä–æ–¥–∞–∂–∞, –∞—Ä–µ–Ω–¥–∞ –≤–∏–ª–ª/–∫–≤–∞—Ä—Ç–∏—Ä)',
            'beauty': '–º–∞—Å—Ç–µ—Ä –∫—Ä–∞—Å–æ—Ç—ã (–º–∞–Ω–∏–∫—é—Ä, –±—Ä–æ–≤–∏, –º–∞–∫–∏—è–∂, –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è)',
            'transport': '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —É—Å–ª—É–≥–∏ (–∞—Ä–µ–Ω–¥–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞, —Ç–∞–∫—Å–∏, —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—ã)',
            'tourism': '—Ç—É—Ä–∏–∑–º –∏ —ç–∫—Å–∫—É—Ä—Å–∏–∏ (–≥–∏–¥—ã, —Ç—É—Ä—ã, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–¥—ã—Ö–∞)',
            'default': '–±–∏–∑–Ω–µ—Å/—É—Å–ª—É–≥–∏ (–æ–±—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)'
        }
        return contexts.get(service_type, contexts['default'])
    
    async def rephrase_text(self, text: str, max_tokens: int = 300) -> Optional[str]:
        """
        –ü—Ä–æ—Å—Ç–∞—è –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –±–æ—Ç–∞ (–¥–ª—è Kammora –∏ –¥—Ä—É–≥–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π)
        
        Args:
            text: –¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
            max_tokens: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
        
        Returns:
            –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        if not self.api_key:
            return None
        
        prompt = f"""–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–æ–∏—Å–∫ —É—Å–ª—É–≥–∏, —Å–æ—Ö—Ä–∞–Ω–∏–≤ —Å–º—ã—Å–ª –∏ —Å—Ç–∏–ª—å. 
–°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –¥–ª—è Telegram-—á–∞—Ç–∞. 
–í–ê–ñ–ù–û: –≠—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∏—Å–∫ —É—Å–ª—É–≥–∏/—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–ò—â—É –º–∞—Å—Ç–µ—Ä–∞", "–ò—â—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞"). 
–ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–∞—Ö, —Å–µ—Ä–≤–∏—Å–∞—Ö, —Ä–µ–∫–ª–∞–º–µ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —É—Å–ª—É–≥–∞—Ö. 
–ù–ï —É–ø–æ–º–∏–Ω–∞–π @Lead_Hunbot –∏–ª–∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –±–æ—Ç—ã. 
–ù–ï —É–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ —Ç–µ–∫—Å—Ç –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ò–ò.
–ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∏—Å–∫ —É—Å–ª—É–≥–∏, —Å–æ—Ö—Ä–∞–Ω–∏–≤ —Ñ–æ—Ä–º–∞—Ç "–ò—â—É [—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞/—É—Å–ª—É–≥—É]".

–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç:
"{text}"

–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:"""
        
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É OpenAI, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
            if HAS_OPENAI_LIB and self.client:
                response = await self.client.chat.completions.create(
                    model="gpt-4o-mini",
                    messages=[
                        {
                            "role": "system",
                            "content": "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–∏—Å–∫ —É—Å–ª—É–≥ –¥–ª—è Telegram-—á–∞—Ç–æ–≤. –¢—ã –ù–ï –¥–æ–±–∞–≤–ª—è–µ—à—å —Ä–µ–∫–ª–∞–º—É –±–æ—Ç–æ–≤ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤. –¢—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—à—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∏—Å–∫ —É—Å–ª—É–≥–∏/—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è—è —Ñ–æ—Ä–º–∞—Ç '–ò—â—É [—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞/—É—Å–ª—É–≥—É]'."
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    temperature=0.7,
                    max_tokens=max_tokens,
                    timeout=10.0
                )
                content = response.choices[0].message.content.strip()
                logger.info(f"‚úÖ ChatGPT –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–ª —Ç–µ–∫—Å—Ç ({len(content)} —Å–∏–º–≤–æ–ª–æ–≤)")
                return content
            
            # Fallback —á–µ—Ä–µ–∑ aiohttp
            elif not HAS_OPENAI_LIB:
                api_base = self.api_base or "https://api.openai.com/v1"
                url = f"{api_base}/chat/completions"
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                payload = {
                    "model": "gpt-4o-mini",
                    "messages": [
                        {
                            "role": "system",
                            "content": "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–∏—Å–∫ —É—Å–ª—É–≥ –¥–ª—è Telegram-—á–∞—Ç–æ–≤. –¢—ã –ù–ï –¥–æ–±–∞–≤–ª—è–µ—à—å —Ä–µ–∫–ª–∞–º—É –±–æ—Ç–æ–≤ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤. –¢—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—à—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∏—Å–∫ —É—Å–ª—É–≥–∏/—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è—è —Ñ–æ—Ä–º–∞—Ç '–ò—â—É [—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞/—É—Å–ª—É–≥—É]'."
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.7,
                    "max_tokens": max_tokens
                }
                
                async with aiohttp.ClientSession() as session:
                    async with session.post(url, headers=headers, json=payload, timeout=aiohttp.ClientTimeout(total=10)) as resp:
                        if resp.status == 200:
                            data = await resp.json()
                            content = data['choices'][0]['message']['content'].strip()
                            logger.info(f"‚úÖ ChatGPT –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–ª —Ç–µ–∫—Å—Ç ({len(content)} —Å–∏–º–≤–æ–ª–æ–≤)")
                            return content
                        else:
                            error_text = await resp.text()
                            logger.error(f"‚ùå ChatGPT API error: {resp.status} - {error_text}")
                            return None
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–µ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ ChatGPT: {e}")
            return None
    
    async def _call_chatgpt_api(self, prompt: str) -> Optional[str]:
        """
        –í—ã–∑—ã–≤–∞–µ—Ç ChatGPT API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
        """
        if not self.api_key:
            return None
        
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É OpenAI, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
            if HAS_OPENAI_LIB and self.client:
                response = await self.client.chat.completions.create(
                    model="gpt-4o-mini",  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –¥–µ—à–µ–≤—É—é –º–æ–¥–µ–ª—å –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
                    messages=[
                        {
                            "role": "system",
                            "content": "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–¥–∞–≤–∞—Ç—å Telegram-–±–æ—Ç–∞ —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤—ã–π –≤ –ø—Ä–æ–¥–∞–∂–∞—Ö."
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    temperature=0.8,  # –ù–µ–º–Ω–æ–≥–æ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º
                    max_tokens=200,  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–∞
                    timeout=10.0
                )
                content = response.choices[0].message.content.strip()
                logger.info(f"‚úÖ ChatGPT —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –æ—Ç–≤–µ—Ç ({len(content)} —Å–∏–º–≤–æ–ª–æ–≤)")
                return content
            
            # Fallback —á–µ—Ä–µ–∑ aiohttp, –µ—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ openai –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
            elif not HAS_OPENAI_LIB:
                api_base = self.api_base or "https://api.openai.com/v1"
                url = f"{api_base}/chat/completions"
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                payload = {
                    "model": "gpt-4o-mini",
                    "messages": [
                        {
                            "role": "system",
                            "content": "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–¥–∞–≤–∞—Ç—å Telegram-–±–æ—Ç–∞ —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤—ã–π –≤ –ø—Ä–æ–¥–∞–∂–∞—Ö."
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.8,
                    "max_tokens": 200,
                }
                
                async with aiohttp.ClientSession() as session:
                    async with session.post(url, headers=headers, json=payload, timeout=aiohttp.ClientTimeout(total=10)) as response:
                        if response.status == 200:
                            data = await response.json()
                            content = data['choices'][0]['message']['content'].strip()
                            logger.info(f"‚úÖ ChatGPT —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –æ—Ç–≤–µ—Ç ({len(content)} —Å–∏–º–≤–æ–ª–æ–≤)")
                            return content
                        else:
                            error_text = await response.text()
                            logger.error(f"‚ùå ChatGPT API –æ—à–∏–±–∫–∞ {response.status}: {error_text}")
                            return None
            
            return None
            
        except asyncio.TimeoutError:
            logger.error("‚ùå ChatGPT API timeout")
            return None
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ ChatGPT API: {e}")
            return None


# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
if __name__ == "__main__":
    import asyncio
    
    async def test():
        generator = ChatGPTResponseGenerator()
        
        test_messages = [
            ("–ü—Ä–∏–≤–µ—Ç! –Ø —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ, –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é –Ω–∞ –ë–∞–ª–∏. –¶–µ–Ω—ã –æ—Ç 100$", "photo_video"),
            ("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü—Ä–µ–¥–ª–∞–≥–∞—é –∞—Ä–µ–Ω–¥—É –≤–∏–ª–ª—ã –Ω–∞ –ë–∞–ª–∏. 3 —Å–ø–∞–ª—å–Ω–∏, –±–∞—Å—Å–µ–π–Ω", "real_estate"),
            ("–ü—Ä–∏–≤–µ—Ç! –î–µ–ª–∞—é –º–∞–Ω–∏–∫—é—Ä –∏ –ø–µ–¥–∏–∫—é—Ä. –í—ã–µ–∑–¥ –Ω–∞ –¥–æ–º. –¶–µ–Ω—ã –æ—Ç 50$", "beauty"),
        ]
        
        print("üß† –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ChatGPT Response Generator:")
        print("=" * 80)
        
        for message, service_type in test_messages:
            response = await generator.generate_selling_response(message, service_type)
            if response:
                print(f"\nüì• –°–æ–æ–±—â–µ–Ω–∏–µ: {message}")
                print(f"üì§ –û—Ç–≤–µ—Ç: {response}")
                print("-" * 80)
            else:
                print(f"\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –¥–ª—è: {message}")
    
    asyncio.run(test())

