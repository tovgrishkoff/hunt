#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
"""

import asyncio
import json
import os
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils import executor
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫
BOT_TOKEN = "7135926908:AAF5r7P-PtPTy2L8SZOm2tNQxqraMHkZyzA"
TEST_USER_ID = "210147380"

async def test_buttons():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –∫–Ω–æ–ø–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏"""
    bot = Bot(token=BOT_TOKEN)
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    message_text = (
        "üîî **–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**\n\n"
        "üîç **–¢–∏–ø:** –ü–û–ò–°–ö\n"
        "üìÇ **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:** –§–æ—Ç–æ–≥—Ä–∞—Ñ, –í–∏–¥–µ–æ–≥—Ä–∞—Ñ\n"
        "‚ö° **–°—Ä–æ—á–Ω–æ—Å—Ç—å:** —Å—Ä–æ—á–Ω–æ\n"
        "üí∞ **–ë—é–¥–∂–µ—Ç:** 500$\n\n"
        "üìÑ **–°–æ–æ–±—â–µ–Ω–∏–µ:**\n"
        "–ò—â—É –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞ –∏ –≤–∏–¥–µ–æ–≥—Ä–∞—Ñ–∞ –Ω–∞ —Å–≤–∞–¥—å–±—É 15 –∞–≤–≥—É—Å—Ç–∞. "
        "–ù—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è —Å—ä–µ–º–∫–∞ —Ü–µ—Ä–µ–º–æ–Ω–∏–∏ –∏ –±–∞–Ω–∫–µ—Ç–∞. –ë—é–¥–∂–µ—Ç –¥–æ 500$. "
        "–ü–∏—à–∏—Ç–µ –≤ –ª–∏—á–∫—É —Å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –∏ —Ü–µ–Ω–∞–º–∏.\n\n"
        "üë§ @wedding\\_planner\n\n"
        "üí¨ **–ß–∞—Ç:** –ë–∞–ª–∏ –ß–∞—Ç | –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å"
    )
    
    # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
    message_id = "test_message_123"
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏
    keyboard = InlineKeyboardMarkup(row_width=2)
    keyboard.add(
        InlineKeyboardButton("‚úÖ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ", callback_data=f"relevant_{message_id}_{TEST_USER_ID}"),
        InlineKeyboardButton("‚ùå –ù–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ", callback_data=f"not_relevant_{message_id}_{TEST_USER_ID}")
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
    keyboard.add(
        InlineKeyboardButton("üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é", callback_data=f"correct_{message_id}_{TEST_USER_ID}")
    )
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await bot.send_message(
            TEST_USER_ID,
            message_text,
            parse_mode="Markdown",
            reply_markup=keyboard
        )
        print("‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        instruction = (
            "üìã **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∫–Ω–æ–ø–æ–∫:**\n\n"
            "1. **‚úÖ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ** - –Ω–∞–∂–º–∏—Ç–µ, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ –¥–ª—è –≤–∞—Å\n"
            "2. **‚ùå –ù–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ** - –Ω–∞–∂–º–∏—Ç–µ, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç\n"
            "3. **üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é** - –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è AI –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏\n\n"
            "–ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏:\n"
            "‚Ä¢ –í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ñ–∞–π–ª `relevance_feedback.json`\n"
            "‚Ä¢ –ö–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤—è—Ç—Å—è –∏ –ø–æ–∫–∞–∂—É—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è\n"
            "‚Ä¢ AI —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —É—á–∏—Ç—å—Å—è –Ω–∞ –≤–∞—à–∏—Ö –æ—Ü–µ–Ω–∫–∞—Ö\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–∂–∞—Ç—å –Ω–∞ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É!"
        )
        
        await bot.send_message(TEST_USER_ID, instruction, parse_mode="Markdown")
        print("‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
    
    finally:
        await bot.session.close()

async def show_feedback_stats():
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    try:
        with open("relevance_feedback.json", "r", encoding="utf-8") as f:
            feedbacks = json.load(f)
        
        total = len(feedbacks)
        relevant = sum(1 for f in feedbacks if f.get("is_relevant", False))
        not_relevant = total - relevant
        
        stats_text = (
            "üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏:**\n\n"
            f"üìà –í—Å–µ–≥–æ –æ—Ü–µ–Ω–æ–∫: {total}\n"
            f"‚úÖ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö: {relevant}\n"
            f"‚ùå –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö: {not_relevant}\n"
            f"üìä –ü—Ä–æ—Ü–µ–Ω—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö: {(relevant/total*100):.1f}% (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ü–µ–Ω–∫–∏)\n\n"
            "üí° –≠—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç —É–ª—É—á—à–∏—Ç—å AI –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é"
        )
        
        bot = Bot(token=BOT_TOKEN)
        await bot.send_message(TEST_USER_ID, stats_text, parse_mode="Markdown")
        await bot.session.close()
        
        print("‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!")
        
    except FileNotFoundError:
        print("üìù –§–∞–π–ª —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

if __name__ == "__main__":
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏...")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
    asyncio.run(test_buttons())
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏
    print("üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ '–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ'...")
    try:
        # –°–æ–∑–¥–∞–µ–º callback query –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        from aiogram.types import CallbackQuery
        callback_data = f"relevant_test_message_{TEST_USER_ID}"
        
        # –ò–º–∏—Ç–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏
        print(f"üìù –û—Ç–ø—Ä–∞–≤–ª—è–µ–º callback: {callback_data}")
        
        # –ó–¥–µ—Å—å –º—ã –Ω–µ –º–æ–∂–µ–º —Ä–µ–∞–ª—å–Ω–æ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É, –Ω–æ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
        print("‚úÖ Callback –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞)")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–Ω–æ–ø–∫–∏: {e}")
    
    print("üìù –§–∞–π–ª —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    import time
    time.sleep(2)
    asyncio.run(show_feedback_stats())
    
    print("‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!") 