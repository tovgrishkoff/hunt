import asyncpg

class Database:
    def __init__(self, dsn):
        self.dsn = dsn
        self.pool = None

    async def connect(self):
        self.pool = await asyncpg.create_pool(dsn=self.dsn)

    async def close(self):
        if self.pool:
            await self.pool.close()

    async def add_message(self, category, sender_name, chat_title, message_text, message_link):
        async with self.pool.acquire() as conn:
            await conn.execute(
                '''
                INSERT INTO messages (category, sender_name, chat_title, message_text, message_link)
                VALUES ($1, $2, $3, $4, $5)
                ''',
                category, sender_name, chat_title, message_text, message_link
            )

    # ... и так далее для всех методов ...

# Паттерны для категоризации сообщений
PATTERNS = {
    "услуги": {
        "keywords": ["услуги", "услуга", "помощь", "помогу", "сделаю", "выполню", "предлагаю", "предложение", "фотограф", "фотосессия", "фотосъемка", "ищу", "ищем", "нужен", "нужна", "нужны"],
        "required_fields": [],
        "price_patterns": [
            r'\b(?:бюджет|цена|стоимость|price|cost|budget)?\s*[:]??\s*\d+\s*(?:k|т|тыс|тысяч|k|₽|руб|рублей|долл|usd|\$)\b',
            r'\b(?:от|до)?\s*\d+\s*(?:k|т|тыс|тысяч|k|₽|руб|рублей|долл|usd|\$)\b',
            r'\b\d+\s*(?:k|т|тыс|тысяч|k|₽|руб|рублей|долл|usd|\$)\s*(?:в\s*месяц|в\s*день|в\s*час)?\b'
        ],
        "date_patterns": [
            r'\b(?:срок|duration|период|period|когда|when)?\s*[:]??\s*(?:через|in|after)?\s*\d+\s*(?:день|дня|дней|месяц|месяца|месяцев|год|года|лет|неделю|недели|недель)\b',
            r'\b(?:с|от|до|начиная\s*с)\s*\d{1,2}[./]\d{1,2}(?:[./]\d{2,4})?\b',
            r'\b(?:январь|февраль|март|апрель|май|июнь|июль|август|сентябрь|октябрь|ноябрь|декабрь)\b'
        ],
        "contact_patterns": [
            r'\b(?:контакты|contact|связаться|связь|пишите|напишите|dm|direct message)?\s*[:]??\s*@[_]{5,32}\b',
            r'\b(?:телеграм|тг|telegram|tg)?\s*[:]??\s*@[_]{5,32}\b',
            r'\b(?:пишите|напишите|связь|связаться)\s*[:]??\s*@[_]{5,32}\b'
        ]
    },
    # ... (остальной большой словарь PATTERNS, как в developer_copy/patterns.py) ...
}

# Фильтры для отсеивания спама
SPAM_FILTERS = {
    "min_message_length": 20,  # Минимальная длина сообщения
    "max_special_chars": 5,    # Максимальное количество спецсимволов
    "max_emojis": 3,           # Максимальное количество эмодзи
    "min_user_age_days": 7,    # Минимальный возраст аккаунта
    "min_user_messages": 10,   # Минимальное количество сообщений пользователя
    "spam_keywords": [         # Слова, указывающие на спам
        "криптовалюта",
        "бинарные опционы",
        "быстрый заработок",
        "инвестиции",
        "казино",
        "ставки",
        "лотерея",
        "розыгрыш",
        "приз",
        "выигрыш",
        "бесплатно",
        "акция",
        "скидка",
        "распродажа",
        "купи",
        "продай",
        "заработок",
        "деньги",
        "кредит",
        "займ",
        "личный кабинет",
        "продам личный кабинет",
        "куплю личный кабинет",
        "продам лк",
        "куплю лк",
        "продам карту",
        "куплю карту",
        "продам пушкинскую карту",
        "куплю пушкинскую карту",
        "оплата на любую карту",
        "swift",
        "sepa",
        "пробив по линии",
        "пробив по базе",
        "пробив по фнс",
        "пробив по мвд",
        "пробив по гибдд",
        "пробив по загс",
        "пробив по пфр",
        "пробив по налоговой",
        "пробив по полиции",
        "онлайн-подработка",
        "без опыта",
        "личные данные не нужны",
        "гарант всегда за",
        "моментальная оплата",
        "оплата моментальная",
        "оплата на карту",
        "оплата на любую карту",
        "работа на дому",
        "удаленная работа",
        "инвайт",
        "рассылка",
        "парсинг",
        "боты — технические решения",
        "дизайн — графика",
        "новые пользователи без накруток",
        "пиши: @",
        "контакты: @",
        "контакт: @",
        "пиши в лс",
        "пишите в лс",
        "пишите: @",
        "по всем вопросам обращаться",
        "по всем вопросам пишите",
        "по всем вопросам в лс",
        "входной тест",
        "вхідний тест",
        "тест за оплату",
        "пропуск за",
        "тест на",
        "пройти тест",
        "пройти вхідний тест",
        "вхідна оплата",
        "входная оплата",
        "тест.*оплата",
        "оплата.*тест",
        "darknet",
        "dark net",
        "даркнет",
        "обучение darknet",
        "обучение даркнет",
        "it сферы darknet",
        "эскортница",
        "эскорт",
        "индивидуалка",
        "проститут",
        "ночь.*₽",
        "час.*₽",
        "готов.*к.*встрече",
        "без предоплаты",
        "в квартире одна",
        "стажер на wb",
        "стажер на вб",
        "помощник на wb",
        "помощник для wb",
        "работа на wb",
        "работа на вб",
        "wb без опыта",
        "вб без опыта",
        "wb обучу",
        "вб обучу",
        "wildberries стажер",
        "wildberries помощник",
        "маркетплейс стажер",
        "маркетплейс помощник",
        "стажер.*wb.*удаленка",
        "помощник.*wb.*удаленка",
        "карточки товара",
        "отвечать на отзывы wb",
        "отвечать на отзывы вб",
        "ассистент.*маркетплейс",
        "ассистент.*wb",
        "ассистент.*вб",
        "ассистент.*ozon",
        "ассистент.*озон",
        "ассистент.*платформ.*ozon",
        "ассистент.*платформ.*озон",
        "ассистент.*работ.*маркетплейс",
        "ассистент.*фотоконтент.*маркетплейс",
        "менеджер.*маркетплейс",
        "менеджер.*wb",
        "менеджер.*вб",
        "менеджер.*ozon",
        "менеджер.*озон",
        "менеджер вб и озон",
        "ищ.*менеджер.*маркетплейс",
        "ищ.*ассистент.*маркетплейс",
        "ищ.*менеджер.*wb",
        "ищ.*менеджер.*вб",
        "ищ.*ассистент.*wb",
        "ищ.*ассистент.*вб",
        "ищ.*менеджер.*ozon",
        "ищ.*ассистент.*ozon",
        # Спам про работу "требуется несколько человек"
        "требуется несколько человек",
        "требуется несколько человек для помощи",
        "подготовке концертной площадки",
        "расстановка оборудования",
        "помощь организаторам",
        "уборка территории",
        "заработать за короткое время",
        "оплата высокая.*подробности в личных",
        "оплата высокая.*в личных сообщениях"
    ],
    "required_fields": {       # Обязательные поля для каждой категории
        "Услуги": ["цена", "срок", "контакты"],
        "Недвижимость": ["цена", "район", "срок", "контакты"],
        "Туры": ["дата", "количество", "бюджет"],
        "Транспорт": ["модель", "срок", "цена"],
        "Работа": ["должность", "опыт", "зарплата"],
        "Мероприятия": ["дата", "гости", "бюджет"]
    }
}

# Ключевые слова для каждой ниши
NICHES_KEYWORDS = {
    "Фотограф": [
        # Базовые слова
        r"\bфотограф(а|ов|ом|ами)?\b", r"\bфотосесси(я|и|й|ю|ями|ях)\b", r"\bфотосъемк(а|и|у|ой|ами|ах)\b", 
        r"\bфотографировать\b", r"\bфотостуди(я|и|й|ю|ями|ях)\b",
        # Камера только в контексте фотографии (не техники)
        r"\bкамер(а|ы|е|ой|у|ах)\b(?!.*(?:iphone|айфон|телефон|смартфон|продам|продаю|продается|gb|гб|mln|млн|imei|батаре|аккумулятор))", 
        r"\bсъемк(а|и|у|ой|ами|ах|и|ой|у)\b", r"\bсъёмк(а|и|у|ой|ами|ах|и|ой|у)\b", r"\bпортрет(а|ы|е|ом|ами|ах)?\b",
        
        # Поиск фотографа (улучшенные паттерны)
        r"(ищ(у|ем|ется)|требуется|подскажите|посовет|нуж(на|ен|ны)|помогите|хочу найти|ищем|ищу|порекомендуйте|рекомендуйте|рекомендац).{0,150}(фотограф(а|ов|ом)?|фотосесси|съемк|съёмк|камер|портрет|фото)",
        r"(ищ(у|ем|ется)|нуж(на|ен|ны)|требуется|порекомендуйте|рекомендуйте).{0,100}(мобильн(ого|ый|ого|ую)?|профессиональн(ого|ый|ого|ую)?|классн(ого|ый|ого|ую)?|хорош(его|ий|его|ую)?|крут(ого|ой|ого|ую)?|семейн(ого|ый|ого|ую)?).{0,50}(фотограф(а|ов)?|фотосесси|съемк|съёмк)",
        r"(ищ(у|ем|ется)|нуж(на|ен|ны)|требуется).{0,100}(фотограф(а|ов)?|фотосесси|съемк|съёмк).{0,100}(на свадьбу|на мероприятие|для свадьбы|для мероприятия|на фотосессию|для фотосессии|для съемки|для съёмки|виллы|виллу|для виллы|для размещения|в аккаунтах|airbnb|booking)",
        r"(где|как|кто|подскажите|порекомендуйте).{0,50}(найти|найду|есть|умеет|умею|умеем).{0,50}(фотограф(а|ов)?|фотосесси|съемк|съёмк|фотографировать)",
        r"(стоимость|цена|сколько стоит|бюджет|деньгами не обижу).{0,50}(фотосесси|съемк|съёмк|фото|фотограф)",
        r"\bищу фотограф\b", r"\bнужен фотограф\b", r"\bнужна фотосесси\b", r"\bнужен человек.*фотографир\b",
        r"\bпришлите.{0,50}(работы|портфолио|примеры).{0,50}(в директ|в лс|в личку)\b",
        r"\b(фото|съемк|съёмк).{0,50}(как из пинтерест|pinterest|пинтерест)\b",
        
        # Паттерны для "кто умеет фотографировать", "нужен человек" и т.д.
        r"\b(кто|нужен человек).{0,100}(умеет|умею|умеем|может).{0,100}(красиво|хорошо|профессионально).{0,50}(фотографировать|фото|снимать|съемк|съёмк)",
        r"\b(кто|нужен человек).{0,50}(фотографировать|фото|снимать|съемк|съёмк).{0,50}(красиво|хорошо|места)",
        r"\b(умеет|умею|умеем).{0,50}(красиво|хорошо|профессионально).{0,50}(фотографировать|фото|снимать)",
        
        # Паттерны для "для съёмки", "для съемки"
        r"\b(для|на).{0,30}(съемк(и|у|ой|ами|ах)|съёмк(и|у|ой|ами|ах)).{0,100}(виллы|виллу|продукта|магазина|бизнеса|инстаграм|соцсетей|airbnb|booking)",
        r"\bфотограф.{0,100}(для|на).{0,30}(съемк(и|у|ой|ами|ах)|съёмк(и|у|ой|ами|ах))",
        r"\b(съемк(и|а|у|ой|ами|ах)|съёмк(и|а|у|ой|ами|ах)).{0,100}(для|на).{0,50}(виллы|виллу|airbnb|booking|размещения|аккаунтов)",
        
        # Специфичные типы фотографов (улучшенные)
        r"\b(свадебн(ый|ого|ому|ым|ом|ая|ой|ую|ою|ые|ых|ыми)?|семейн(ый|ого|ому|ым|ом|ая|ой|ую|ою|ые|ых|ыми)?|детск(ий|ого|ому|им|ом|ая|ой|ую|ою|ие|их|ими)?|мобильн(ый|ого|ому|ым|ом|ая|ой|ую|ою|ые|ых|ыми)?|профессиональн(ый|ого|ому|ым|ом|ая|ой|ую|ою|ые|ых|ыми)?|крут(ого|ой|ого|ую|ые|ых|ыми)?).{0,50}(фотограф(а|ов)?|фотосесси|съемк|съёмк)\b",
        r"\b(фотограф(а|ов)?|фотосесси|съемк|съёмк).{0,50}(на свадьбу|на мероприятие|для свадьбы|для мероприятия|свадебн(ую|ая|ый|ые)?|семейн(ую|ая|ый|ые)?|детск(ую|ая|ий|ие)?)\b",
        
        # Контент и соцсети
        # ВАЖНО: слова вроде "прайс/портфолио/reels" слишком общие и дают ложные срабатывания
        # (например, "Запросить прайс" в банковских/прочих услугах). Поэтому требуем фото/съёмка контекст.
        r"\bконтент[- ]?мейкер\b.{0,80}(фото|фотограф|фотосесси|съемк|съёмк|видео|видеограф)",
        r"(фото|фотограф|фотосесси|съемк|съёмк|видео|видеограф).{0,80}\bконтент[- ]?мейкер\b",
        r"\b(reels|рилсы)\b.{0,80}(фото|фотограф|фотосесси|съемк|съёмк|видео|видеограф)",
        r"(фото|фотограф|фотосесси|съемк|съёмк|видео|видеограф).{0,80}\b(reels|рилсы)\b",
        r"\b(портфолио|прайс)\b.{0,80}(фото|фотограф|фотосесси|съемк|съёмк)",
        r"(фото|фотограф|фотосесси|съемк|съёмк).{0,80}\b(портфолио|прайс)\b",
        r"\bсъемка на воде\b", r"\bконтент для соцсетей\b",
        r"\bсъемка для инстаграм\b", r"\bсъемка для соцсетей\b", r"\bсъемка для бизнеса\b",
        r"\bсъемка для детей\b", r"\bсъемка для семьи\b", r"\bсъемка для свадьбы\b",
        r"\bсъемка для продукта\b", r"\bсъемка для магазина\b", r"\bсъемка для маркетплейса\b",
        r"\b(фото|съемк|съёмк).{0,30}(как из пинтерест|pinterest|пинтерест)\b",
        r"\bпришлите.{0,50}(работы|портфолио|примеры).{0,50}(в директ|в лс|в личку)\b",
        
        # Дополнительные паттерны для пропущенных случаев
        r"\bищем.{0,100}(фотограф|семейн(ого|ый).{0,30}фотограф)",
        r"\b(портфолио|условия).{0,50}(пожалуйста|скидывайте|в личные сообщения|в директ)"
    ],
    "Видеограф": [
        # Базовые слова
        r"\bвидеограф(а|ов|ом|ами)?\b", r"\bвидеосъемк(а|и|у|ой|ами|ах)\b", r"\bвидеомонтаж(а|и|у|ом|ами|ах)?\b", 
        r"\bвидеоролик(а|и|у|ом|ами|ах)?\b", r"\bклип(а|ы|е|ом|ами|ах)?\b", r"\bрекламн(ый|ого|ому|ым|ом|ая|ой|ую|ою|ые|ых|ыми)?.{0,30}ролик\b",
        r"\bсвадебн(ое|ого|ому|ым|ом|ая|ой|ую|ою|ые|ых|ыми)?.{0,30}видео\b", r"\bвидеокамер(а|ы|е|ой|у|ах)\b", 
        r"\bвидеооператор(а|ов|ом|ами)?\b", r"\bмонтаж(а|и|у|ом|ами|ах)?\b", r"\bоператор(а|ов|ом|ами)?\b",
        
        # Поиск видеографа (улучшенные паттерны)
        r"(ищ(у|ем|ется)|требуется|подскажите|посовет|нуж(на|ен|ны)|помогите|хочу найти|ищем|ищу).{0,150}(видеограф(а|ов|ом)?|видеосъемк|видеомонтаж|оператор(а|ов)?|съемк|видео)",
        r"(ищ(у|ем|ется)|нуж(на|ен|ны)|требуется).{0,100}(мобильн(ого|ый|ого|ую)?|профессиональн(ого|ый|ого|ую)?|классн(ого|ый|ого|ую)?|хорош(его|ий|его|ую)?).{0,50}(видеограф(а|ов)?|оператор(а|ов)?|съемк|видео)",
        r"(ищ(у|ем|ется)|нуж(на|ен|ны)|требуется).{0,100}(видеограф(а|ов)?|оператор(а|ов)?|съемк|видео).{0,100}(на свадьбу|на мероприятие|для свадьбы|для мероприятия|на съемку|для съемки|в зале|тренировк)",
        r"(ищ(у|ем|ется)|нуж(на|ен|ны)|требуется).{0,100}(видеограф(а|ов)?|оператор(а|ов)?).{0,100}(с Бали|на Бали|на бали)",
        r"(где|как|кто|подскажите).{0,50}(найти|найду|есть).{0,50}(видеограф(а|ов)?|оператор(а|ов)?|съемк|видео)",
        r"(стоимость|цена|сколько стоит|бюджет).{0,50}(видеосъемк|видеомонтаж|видео|видеограф)",
        r"(есть опыт|опыт таких съемок|может отснять|отснять).{0,100}(тренировк|в зале|съемк|видео)",
        r"\bищу видеограф\b", r"\bнужен видеограф\b", r"\bнужен оператор\b",
        r"\b(видеограф|оператор).{0,50}(на.{0,50}(свадьб|мероприяти|съемк|январ|феврал|март))\b",
        
        # Контент и соцсети
        r"\bконтент[- ]?мейкер\b", r"\breels\b", r"\bрилсы\b",
        r"\bсъемка на воде\b", r"\bсъемка с дроном\b", r"\bинтервью\b", r"\bподкаст\b",
        r"\bсъемка для инстаграм\b", r"\bсъемка для youtube\b", r"\bсъемка для tiktok\b",
        r"\bсъемка для stories\b", r"\bсъемка для бизнеса\b", r"\bсъемка для детей\b",
        r"\bсъемка для семьи\b", r"\bсъемка для свадьбы\b", r"\bсъемка для продукта\b",
        r"\bсъемка для магазина\b", r"\bсъемка для маркетплейса\b",
        r"\bтренировк(и|у|ой|ами|ах).{0,50}(в зале|зал|съемк|видео)\b"
    ],
    "Сдача недвижимости": [
        # Предложение (сдача в аренду)
        r"\bсдам\b", r"\bсдается\b", r"\bсдаю\b", r"\bсдаем\b", r"\bсдаются\b",
        # Явная аренда жилья (без "снять/сдам")
        r"\bаренд\w*\s+(жиль\w*|квартир\w*|дом\w*|вилл\w*|апартамент\w*)\b",
        r"\b(жиль\w*|квартир\w*|дом\w*|вилл\w*|апартамент\w*)\s+аренд\w*\b",
        # Проживание/студии/BR (часто без слов "жильё/квартира/вилла")
        r"\bстоимость\s+прожив\w*\b",
        r"\b(прожив\w*|проживание)\b.{0,120}(к/ноч|/ноч|за\s+ноч|ноч\w*|/мес|/месяц|в\s+месяц|месяц|мес)\b",
        r"\b(studio|студи\w*|king\s+studio|кинг\s+студи\w*)\b.{0,160}(к/ноч|/ноч|за\s+ноч|ноч\w*|месяц|мес|idr|rp|usd|\$|₽|млн|тыс|k)\b",
        r"\b\d+\s*br\b.{0,160}(к/ноч|/ноч|за\s+ноч|ноч\w*|месяц|мес|idr|rp|usd|\$|₽|млн|тыс|k)\b",
        r"\b(br|bedroom)\b.{0,120}(к/ноч|/ноч|за\s+ноч|ноч\w*|месяц|мес|idr|rp|usd|\$|₽|млн|тыс|k)\b",
        # Внутренние признаки размещения (как в типичных объявлениях)
        r"\b(в\s+номере|ванн\w*\s+комнат\w*|кухн\w*|ежедневн\w*\s+уборк\w*|смена\s+белья|полотенц\w*|сейф|халат|тапочк\w*)\b.{0,200}(к/ноч|/ноч|месяц|мес|idr|rp|usd|\$|₽|млн|тыс|k)\b",
        # ВАЖНО: "посуточно/долгосрочная аренда" бывает и у транспорта, поэтому требуем контекст жилья
        r"\bпосуточно\b.{0,60}(жиль\w*|квартир|дом|вилл|апартамент)",
        r"(жиль\w*|квартир|дом|вилл|апартамент).{0,60}\bпосуточно\b",
        r"\b(долгосрочная|краткосрочная)\s+аренда\b.{0,60}(жиль\w*|квартир|дом|вилл|апартамент)",
        r"(жиль\w*|квартир|дом|вилл|апартамент).{0,60}\b(долгосрочная|краткосрочная)\s+аренда\b",
        r"\bаренда квартир(ы|е|ой|у|ах)?\b", r"\bаренда апартамент(ов|ам|ами|ах)?\b", 
        r"\bаренда дом(а|ов|ом|у|ах)?\b", r"\bаренда вилл(ы|е|ой|у|ах)?\b",
        r"\bсдача.{0,50}(квартир|дом|вилл|апартамент)\b",
        r"\b(вилл(а|ы|е|ой|у|ах)?|квартир(а|ы|е|ой|у|ах)?|дом(а|ов|ом|у|ах)?|апартамент(ы|а|ов|ом|ах)?).{0,50}(в аренду|в аренде|сдается|сдаю|сдаем)\b",
        
        # Паттерны для объявлений о виллах с ценой за период (без явного "сдается")
        r"\b(вилл(а|ы|е|ой|у|ах)?|квартир(а|ы|е|ой|у|ах)?|дом(а|ов|ом|у|ах)?|апартамент(ы|а|ов|ом|ах)?).{0,200}(млн|тыс|k|₽|руб|рублей|долл|usd|\$|idr|rp|rupiah).{0,50}(/мес|/месяц|в месяц|за месяц|мес|месяц)\b",
        r"\b(вилл(а|ы|е|ой|у|ах)?|квартир(а|ы|е|ой|у|ах)?|дом(а|ов|ом|у|ах)?|апартамент(ы|а|ов|ом|ах)?).{0,200}(/мес|/месяц|в месяц|за месяц).{0,50}(млн|тыс|k|₽|руб|рублей|долл|usd|\$|idr|rp|rupiah)\b",
        r"\b(новые|свободн(ы|а|ы)?|доступн(ы|а|ы)?|свободны|доступны).{0,100}(вилл(а|ы|е|ой|у|ах)?|квартир(а|ы|е|ой|у|ах)?|дом(а|ов|ом|у|ах)?|апартамент(ы|а|ов|ом|ах)?)\b",
        r"\b(вилл(а|ы|е|ой|у|ах)?|квартир(а|ы|е|ой|у|ах)?|дом(а|ов|ом|у|ах)?|апартамент(ы|а|ов|ом|ах)?).{0,100}(свободн(ы|а|ы)?|доступн(ы|а|ы)?|свободны|доступны)\b",
        r"\b(вилл(а|ы|е|ой|у|ах)?|квартир(а|ы|е|ой|у|ах)?|дом(а|ов|ом|у|ах)?|апартамент(ы|а|ов|ом|ах)?).{0,200}(минимум|от|от.{0,20})\d+.{0,20}(месяц|мес|день|дня|дней|недел|неделю|год)\b",
        r"\b(вилл(а|ы|е|ой|у|ах)?|квартир(а|ы|е|ой|у|ах)?|дом(а|ов|ом|у|ах)?|апартамент(ы|а|ов|ом|ах)?).{0,200}(спальн|ванн|бассейн|участок|м²|кв\.м|кв\.|квадратн).{0,100}(млн|тыс|k|₽|руб|рублей|долл|usd|\$|idr|rp|rupiah).{0,50}(/мес|/месяц|в месяц|за месяц|мес)\b",
        
        # Поиск (снять жилье) - УЛУЧШЕННЫЕ ПАТТЕРНЫ
        r"(ищ(у|ем|ется)|требуется|подскажите|посовет|нуж(на|ен|ны)|помогите|хочу найти|ищем|ищу).{0,150}(снять|сниму|снимаю|снимаем|арендовать|арендую|арендуем).{0,100}(жилье|квартир|дом|вилл|апартамент|жиль)",
        r"(ищ(у|ем|ется)|нуж(на|ен|ны)|требуется).{0,100}(квартир(у|ы|е|ой|у|ах)?|дом(а|ов|ом|у|ах)?|вилл(у|ы|е|ой|у|ах)?|апартамент(ы|а|ов|ом|ах)?|жилье|жиль)",
        r"(ищ(у|ем|ется)|нуж(на|ен|ны)|требуется).{0,100}(снять|арендовать).{0,100}(на.{0,50}(месяц|день|неделю|год)|посуточно|долгосрочно)",
        r"(где|как|подскажите).{0,50}(найти|найду|есть|снять|арендовать).{0,50}(квартир|дом|вилл|апартамент|жилье)",
        # ВАЖНО: "стоимость аренды" без слов про жильё может быть про байки/авто и т.п.
        r"(стоимость|цена|сколько стоит|бюджет).{0,50}(аренд|снять|арендовать).{0,50}(жиль\w*|квартир|дом|вилл|апартамент)",
        # ВАЖНО: одиночные "сниму/арендую" дают ложные срабатывания (например: "сниму видео")
        r"\b(сниму|снимаю|снимаем|арендую|арендуем)\b.{0,60}(жиль\w*|квартир|дом|вилл|апартамент)",
        r"(жиль\w*|квартир|дом|вилл|апартамент).{0,60}\b(сниму|снимаю|снимаем|арендую|арендуем)\b",
        r"\bснять жиль[её]\b", r"\bснять квартиру\b", r"\bснять дом\b", r"\bснять виллу\b",
        r"\bснять апартамент(ы|а|ов|ом|ах)?\b",
        r"\b(квартир(а|ы|е|ой|у|ах)?|дом(а|ов|ом|у|ах)?|вилл(а|ы|е|ой|у|ах)?|апартамент(ы|а|ов|ом|ах)?).{0,50}(в аренду|в аренде|снять|арендовать)\b"
    ],
    "Маникюр": [
        r"\bманикюр\b", r"\bногти\b", r"\bнаращивание ногтей\b", r"\bдизайн ногтей\b", r"\bпедикюр\b",
        r"\bгель-лак\b", r"\bшеллак\b", r"\bмастер маникюра\b", r"\bсалон маникюра\b"
    ],
    "Волосы": [
        r"\bпарикмахер\b", r"\bстрижка\b", r"\bокрашивание\b", r"\bприческа\b", r"\bукладка\b",
        r"\bсалон красоты\b", r"\bпарикмахерская\b", r"\bмастер по волосам\b", r"\bнаращивание волос\b"
    ],
    "Аренда авто": [
        r"\bаренда авто\b", r"\bпрокат авто\b", r"\bаренда машины\b", r"\bпрокат машины\b",
        r"\bаренда автомобиля\b", r"\bпрокат автомобиля\b", r"\bаренда скутера\b", r"\bпрокат скутера\b"
    ],
    "Реснички": [
        # СТРОГИЕ паттерны - только явные упоминания ресниц в контексте услуг
        r"\bнаращивание\s+ресниц\b", r"\bмастер\s+по\s+ресницам\b", r"\bобъем\s+ресниц\b",
        r"\bдизайн\s+ресниц\b", r"\bкоррекци\s+ресниц\b", r"\bлаш\s+мастер\b", r"\blash\s+мастер\b",
        r"\bнаращивани\s+ресниц\b", r"\bмастер\s+ресниц\b", r"\bуслуг\s+по\s+ресницам\b",
        # Более строгий паттерн для "ресницы" - только если есть контекст услуг
        r"(мастер|наращивани|дизайн|объем|коррекци|услуг).{0,30}ресниц",
        r"ресниц.{0,30}(мастер|наращивани|дизайн|объем|коррекци|услуг)",
    ],
    "Брови": [
        r"\bброви\b", r"\bкоррекция бровей\b", r"\bтатуаж бровей\b", r"\bокрашивание бровей\b",
        r"\bмастер по бровям\b", r"\bдизайн бровей\b", r"\bламинирование бровей\b"
    ],
    "Макияж": [
        r"\bмакияж\b", r"\bвизажист\b", r"\bмакияж на свадьбу\b", r"\bвечерний макияж\b",
        r"\bдневной макияж\b", r"\bмастер макияжа\b", r"\bпрофессиональный макияж\b"
    ],
    "Косметология": [
        r"\bкосметолог\b", r"\bчистка лица\b", r"\bпилинг\b", r"\bмассаж лица\b",
        r"\bуход за лицом\b", r"\bомоложение\b", r"\bботокс\b", r"\bфиллеры\b",
        r"\bмезотерапия\b", r"\bбиоревитализация\b"
    ],
    "Продажа недвижимости": [
        # Предложение (продажа) - ТОЛЬКО с упоминанием недвижимости
        r"\bпродам.{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)\b",
        r"\bпродается.{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)\b",
        r"\bпродаю.{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)\b",
        r"\bпродаем.{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)\b",
        r"\bпродаются.{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)\b",
        r"\bквартир(а|ы|е|ой|у|ах)?.{0,50}(продам|продается|продаю|продаем|продаются)\b",
        r"\bдом(а|ов|ом|у|ах)?.{0,50}(продам|продается|продаю|продаем|продаются)\b",
        r"\bвилл(а|ы|е|ой|у|ах)?.{0,50}(продам|продается|продаю|продаем|продаются)\b",
        r"\bапартамент(ы|а|ов|ом|ах)?.{0,50}(продам|продается|продаю|продаем|продаются)\b",
        r"\bучасток(а|и|у|ом|ами|ах)?.{0,50}(продам|продается|продаю|продаем|продаются)\b",
        r"\bземл(я|и|ю|ей|ею|ях)?.{0,50}(продам|продается|продаю|продаем|продаются)\b",
        r"\bнедвижимость(и|ю|ью|ях)?.{0,50}(продам|продается|продаю|продаем|продаются)\b",
        r"\bриелтор(а|ов|ом|ами)?\b",
        r"\bпродажа.{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)\b",
        
        # Поиск (покупка) - ТОЛЬКО с упоминанием недвижимости
        r"(ищ(у|ем|ется)|требуется|подскажите|посовет|нуж(на|ен|ны)|помогите|хочу найти|ищем|ищу|хочу купить|куплю).{0,150}(купить|куплю|покупаю|покупаем).{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)",
        r"(ищ(у|ем|ется)|нуж(на|ен|ны)|требуется|хочу купить|куплю).{0,100}(квартир(у|ы|е|ой|у|ах)?|дом(а|ов|ом|у|ах)?|вилл(у|ы|е|ой|у|ах)?|апартамент(ы|а|ов|ом|ах)?|недвижимость|участок|земл)",
        r"(где|как|подскажите).{0,50}(найти|найду|есть|купить|куплю).{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)",
        r"(стоимость|цена|сколько стоит|бюджет).{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)",
        r"\bкуплю.{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)\b",
        r"\bпокупаю.{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)\b",
        r"\bпокупаем.{0,50}(квартир|дом|вилл|апартамент|недвижимость|участок|земл)\b",
        r"\bкупить квартиру\b", r"\bкупить дом\b", r"\bкупить виллу\b",
        r"\bкупить апартамент(ы|а|ов|ом|ах)?\b", r"\bкупить недвижимость\b",
        r"\bкупить участок\b", r"\bкупить земл\b"
    ],
    "Аренда байков": [
        r"\bаренда байка\b", r"\bпрокат байка\b", r"\bаренда мотоцикла\b",
        r"\bпрокат мотоцикла\b", r"\bаренда скутера\b", r"\bпрокат скутера\b",
        # Более гибкие паттерны: "стоимость аренды" + байк/скутер и т.п.
        r"(аренд\w*|прокат).{0,40}(байк|байки|мото|мотоцикл|скутер|scooter|yamaha|honda|vespa)",
        r"(байк|байки|мото|мотоцикл|скутер|scooter|yamaha|honda|vespa).{0,40}(аренд\w*|прокат)",
        # Встречается формат: "байки ... (описание) ... стоимость аренды"
        r"(байк|байки|мото|мотоцикл|скутер|scooter|yamaha|honda|vespa).{0,500}(стоимость\s+аренд\w*|включено\s+в\s+стоимость\s+аренд\w*|аренд\w*|прокат)",
        r"(стоимость\s+аренд\w*|включено\s+в\s+стоимость\s+аренд\w*|аренд\w*|прокат).{0,500}(байк|байки|мото|мотоцикл|скутер|scooter|yamaha|honda|vespa)",
        # Частые модели/марки
        r"\byamaha\s*(xmax|nmax|aerox)\b",
        r"\bhonda\s*(pcx|adv|vario|click)\b",
        r"\bvespa\b",
    ],
    "Обмен валют": [
        # Базовые слова
        r"\bобмен валют\b", r"\bкурс валют\b", r"\bобменник\b", r"\bобмен денег\b",
        r"\bконвертация\b", r"\bдоллары\b", r"\bевро\b", r"\bрубли\b",
        
        # Криптовалюта (USDT, USDC, тезер, тезеры)
        r"\busdt\b", r"\busdc\b", r"\bтезер(а|ы|у|ом|ами|ах)?\b", r"\bтезеры\b",
        r"\bкриптовалют(а|ы|у|ой|ами|ах)?\b", r"\bкрипт(а|ы|у|ой|ами|ах)?\b",
        
        # Поиск обмена (куплю, продам, обменяю) - УЛУЧШЕННЫЕ ПАТТЕРНЫ
        r"(куплю|покупаю|покупаем|ищу|нужен|нужна|нужны).{0,150}(usdt|usdc|тезер|крипт|доллар|евро|рубл|наличк|нал)",
        r"(продам|продаю|продаем|продаются).{0,150}(usdt|usdc|тезер|крипт|доллар|евро|рубл|наличк|нал)",
        r"(обменяю|обменяем|обмен|меняю|меняем).{0,150}(нал|наличк|доллар|евро|рубл|usdt|usdc|тезер)",
        r"(обменяю|обменяем|обмен|меняю|меняем).{0,150}(на.{0,50}(usdt|usdc|тезер|доллар|евро|рубл|нал))",
        
        # Специфичные фразы (более гибкие, учитывают эмодзи и форматирование)
        r"куплю.{0,20}usdt", r"продам.{0,20}usdt", r"обменяю.{0,20}нал", r"обменяю.{0,20}наличк",
        r"куплю.{0,20}тезер", r"продам.{0,20}тезер", r"обменяю.{0,20}на.{0,20}тезер",
        r"\bкуплю\s+usdt\b", r"\bпродам\s+usdt\b", r"\bобменяю\s+нал\b", r"\bобменяю\s+наличк\b",
        r"\bкуплю\s+тезер\b", r"\bпродам\s+тезер\b", r"\bобменяю\s+на\s+тезер\b",
        r"\bличная встреча\b", r"\bпри встрече\b", r"\bвстреча в городе\b",
        r"\bкурс.{0,50}(выше|ниже|рынок|актуальн)\b",
        r"\b(trc20|erc20|bep20)\b",
        
        # Поиск обмена (улучшенные паттерны)
        r"(ищ(у|ем|ется)|требуется|подскажите|посовет|нуж(на|ен|ны)|помогите|хочу найти|ищем|ищу).{0,150}(обмен|обменяю|меняю|куплю|продам).{0,100}(валют|usdt|usdc|тезер|крипт|доллар|евро|рубл)",
        r"(ищ(у|ем|ется)|нуж(на|ен|ны)|требуется).{0,100}(кто.{0,50}(продаст|продам|продает|продаю)).{0,100}(usdt|usdc|тезер|крипт)",
        r"(где|как|подскажите).{0,50}(найти|найду|есть|обмен|обменять|обменяю).{0,50}(валют|usdt|usdc|тезер|крипт)",
        r"(стоимость|цена|сколько стоит|бюджет|курс).{0,50}(обмен|usdt|usdc|тезер|крипт|валют)",
    ],
    "Кальяны": [
        # ТОЛЬКО про услуги кальянов, НЕ про табак отдельно
        r"\bкальян\b", r"\bкальянная\b", r"\bкальян бар\b", r"\bкальянная комната\b",
        r"\bкальян на дом\b", r"\bкальян с доставкой\b", r"\bкальян мастер\b",
        r"\bзаказать кальян\b", r"\bзаказ кальян\b", r"\bкальян услуги\b",
        # Исключаем простые вопросы про табак без упоминания кальянов
        # (паттерны ниже НЕ должны срабатывать, если нет слова "кальян")
    ],
    "Аренда Playstation": [
        r"\bplaystation\b", r"\bps4\b", r"\bps5\b", r"\bаренда приставки\b",
        r"\bпрокат приставки\b", r"\bигровая приставка\b", r"\bаренда ps\b", r"\bпрокат ps\b"
    ],
    "Медиа-студия": [
        r"\bстудия\b", r"\bфотостудия\b", r"\bвидеостудия\b", r"\bмедиастудия\b",
        r"\bаренда студии\b", r"\bпрокат студии\b", r"\bсъемочная площадка\b", r"\bфото зона\b", r"\bвидео зона\b"
    ],
    "Туризм": [
        # СТРОГИЕ паттерны - только специфичные для туризма (убраны общие слова: цена, стоимость, отзывы, билеты, недвижимость)
        r"\bтур(ы|а|ов|ом|ах)?\b", r"\bэкскурси(я|и|й|ями|ю|ях)\b",
        r"\bгид(ы|а|ов|ом|ах)?\b", r"\bиндивидуальная экскурсия\b", r"\bгрупповой тур\b",
        r"\bбронировать\b", r"\bбронирование\b", r"\bтуркомпан(ия|ии|ий|иями|ию|иях)\b",
        r"\bгде купить тур\b", r"\bтур на (целый|пол|несколько) день(я|ей)?\b",
        r"\bтур (по|в|из) [а-яa-z]+\b", r"\bтур для (семьи|детей|группы|одного)\b",
        r"\bтур с гидом\b", r"\bтур без гида\b", r"\bтур на (лодке|яхте|автобусе)\b",
        r"\bвиза ран\b", r"\bvisa run\b", r"\bпоездк[аи].*тур\b"
    ],
    "Транспорт": [
        # УБРАНА аренда (она в отдельных нишах "Аренда авто" и "Аренда байков")
        # Оставлено только: такси, трансфер, перевозки
        # Доставка убрана, так как часто используется в спаме о товарах/репликах
        r"\bтрансфер\b", r"\bтакси\b", r"\bпоездк[аи]\b", r"\bмаршрут\b",
        r"\bводитель\b", r"\bперевозк[аи]\b"
    ]
}

def handle_source_message(message_text):
    print(f"DEBUG: handle_source_message: {message_text}")
    # Rest of the function code... 