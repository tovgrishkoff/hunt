# ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ Lexus –Ω–∞ PostgreSQL - –ó–ê–í–ï–†–®–ï–ù–û

## üì¶ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. `lexus_db/models.py` (143 —Å—Ç—Ä–æ–∫–∏)
–ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î —Å —Ç—Ä–µ–º—è —Ç–∞–±–ª–∏—Ü–∞–º–∏:
- `Account` - –∞–∫–∫–∞—É–Ω—Ç—ã —Å –ª–∏–º–∏—Ç–∞–º–∏ –∏ FloodWait
- `Target` - –≥—Ä—É–ø–ø—ã —Å –ø—Ä–∏–≤—è–∑–∫–æ–π, warm-up, –ª–∏–º–∏—Ç–∞–º–∏  
- `PostHistory` - –∏—Å—Ç–æ—Ä–∏—è –ø–æ—Å—Ç–æ–≤

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
- `Account.daily_posts_count` (–ª–∏–º–∏—Ç 20)
- `Account.next_allowed_action_time` (FloodWait)
- `Target.assigned_account_id` (—Å—Ç—Ä–æ–≥–∞—è –ø—Ä–∏–≤—è–∑–∫–∞)
- `Target.warmup_ends_at` (24 —á–∞—Å–∞ –ø–æ—Å–ª–µ joined_at)
- `Target.daily_posts_in_group` (–ª–∏–º–∏—Ç 2)

### 2. `lexus_db/session.py` (91 —Å—Ç—Ä–æ–∫–∞)
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Async SQLAlchemy:
- `get_database_url()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `AsyncSessionLocal` - —Ñ–∞–±—Ä–∏–∫–∞ async —Å–µ—Å—Å–∏–π
- `init_db()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Docker —á–µ—Ä–µ–∑ `DATABASE_URL` –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

### 3. `lexus_db/db_manager.py` (391 —Å—Ç—Ä–æ–∫–∞)
–ú–µ–Ω–µ–¥–∂–µ—Ä —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π:

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `assign_group()` - –ø—Ä–∏–≤—è–∑–∫–∞ –≥—Ä—É–ø–ø—ã –∫ –∞–∫–∫–∞—É–Ω—Ç—É
- `get_groups_ready_for_posting()` - –≤—ã–±–æ—Ä–∫–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- `record_post()` - –∑–∞–ø–∏—Å—å –ø–æ—Å—Ç–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
- `set_account_flood_wait()` / `clear_account_flood_wait()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ FloodWait
- `reset_daily_counters_if_needed()` - –∞–≤—Ç–æ—Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤

**–õ–æ–≥–∏–∫–∞ `get_groups_ready_for_posting()`:**
1. –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –Ω–æ–≤—ã–π –¥–µ–Ω—å
2. –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ niche = 'ukraine_cars'
3. status = 'joined' –∏ assigned_account_id IS NOT NULL
4. warmup_ends_at < NOW()
5. daily_posts_in_group < 2
6. –ê–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω –∏ daily_posts_count < 20
7. –ê–∫–∫–∞—É–Ω—Ç –Ω–µ –≤–æ FloodWait

### 4. `lexus_db/migrate_from_files.py` (373 —Å—Ç—Ä–æ–∫–∏)
–°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:
- –ß–∏—Ç–∞–µ—Ç `targets.txt`, `group_niches.json`, `accounts_config.json`
- –§–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ Lexus –∞–∫–∫–∞—É–Ω—Ç—ã (–∏–∑ `lexus_accounts_config.json`)
- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏ (–∏–∑ `group_account_assignments.json`)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç warm-up –ø–µ—Ä–∏–æ–¥—ã

### 5. `lexus_db/__init__.py`
–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –∏ —Ñ—É–Ω–∫—Ü–∏–π

### 6. `LEXUS_DB_MIGRATION_GUIDE.md`
–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 7. `LEXUS_DB_SUMMARY.md`
–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ

- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ –ò–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ú–æ–¥–µ–ª–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å SQLAlchemy 2.0
- ‚úÖ Async —Å–µ—Å—Å–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ DATABASE_URL —Ñ–æ—Ä–º–∞—Ç –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (postgresql+asyncpg://)

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:**
   ```bash
   # –£–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ requirements.txt:
   asyncpg>=0.29.0
   sqlalchemy[asyncio]>=2.0.23
   ```

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å docker-compose.lexus.yml:**
   ```yaml
   environment:
     - DATABASE_URL=postgresql+asyncpg://user:pass@postgres:5432/dbname
   ```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:**
   ```bash
   python3 lexus_db/migrate_from_files.py
   ```

4. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–¥:**
   - –ó–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –≤—ã–∑–æ–≤—ã `DbManager`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `get_groups_ready_for_posting()` –≤–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ —Ñ–∞–π–ª–æ–≤
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `record_post()` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤

## üéØ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

‚úÖ **–°—Ç—Ä–æ–≥–∞—è –ø—Ä–∏–≤—è–∑–∫–∞:** `assigned_account_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `targets`  
‚úÖ **Warm-up:** 24 —á–∞—Å–∞ —á–µ—Ä–µ–∑ `warmup_ends_at`  
‚úÖ **–õ–∏–º–∏—Ç—ã:** 2 –ø–æ—Å—Ç–∞/–≥—Ä—É–ø–ø—É, 20 –ø–æ—Å—Ç–æ–≤/–∞–∫–∫–∞—É–Ω—Ç  
‚úÖ **FloodWait:** `next_allowed_action_time` –∏ `status = 'flood_wait'`  
‚úÖ **Docker:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á–µ—Ä–µ–∑ `DATABASE_URL`  
‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è:** –ü–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–æ–≤  

–í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! üéâ
