# 🧠 ЛОГИКА ACCOUNT MANAGER (09:00 Слот)

**Обновлено:** 2026-01-10

---

## 📊 Визуализация алгоритма

```
┌─────────────────────────────────────────────────────────────┐
│              НАЧАЛО СЛОТА 09:00 (Jakarta)                   │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │ Есть группы в очереди? │
              └────────────────────────┘
                     │            │
              ┌──────┘            └──────┐
              │                          │
             ДА                         НЕТ
              │                          │
              ▼                          ▼
      ┌───────────────┐          ┌──────────────┐
      │ Берем группу X│          │  Конец слота │
      └───────────────┘          └──────────────┘
              │
              ▼
      ┌──────────────────┐
      │ Попытка вступить │
      └──────────────────┘
              │
    ┌─────────┼─────────┬──────────────┐
    │         │         │              │
  УСПЕХ   FloodWait   ОШИБКА     ДРУГАЯ
    │         │         │         ОШИБКА
    ▼         │         │              │
┌─────────┐   │         ▼              │
│Сохранить│   │    ┌──────────────┐   │
│ в БД    │   │    │Пометить как  │   │
└─────────┘   │    │inaccessible  │   │
    │         │    └──────────────┘   │
    ▼         │         │              │
┌─────────┐   │         ▼              │
│ Сон     │   │    ┌──────────────┐   │
│ 5-10 мин│   │    │ Пауза 60 сек │   │
└─────────┘   │    └──────────────┘   │
    │         │         │              │
    └─────────┴─────────┴──────────────┘
              │
              ▼
      ┌──────────────────┐
      │  FloodWait?      │
      └──────────────────┘
              │
    ┌─────────┼─────────┐
    │         │         │
  <=10 мин  >10 мин   НЕТ
    │         │         │
    ▼         ▼         ▼
┌─────────┐┌─────────┐┌─────────┐
│ Сон     ││ Лог:    ││ Продол- │
│ X сек   ││ Long    ││ жаем    │
└─────────┘│ Flood   │└─────────┘
    │      │ Wait    │
    ▼      └─────────┘
┌─────────┐     │
│Пропуск  │     │
│группы   │◄────┘
└─────────┘
    │
    └─────────────────┐
                      │
                      ▼
            (Возврат к проверке очереди)
```

---

## 🔄 Детальное описание логики

### 1. Инициализация слота
- Время: **09:00 (Asia/Jakarta)**
- Проверка: Есть ли группы со статусом `new`?

### 2. Обработка групп
- **Лимит:** 3-5 групп за слот (вместо неограниченного)
- **Последовательность:**
  1. Берём группу из очереди (`status='new'`)
  2. Выбираем наименее загруженный аккаунт
  3. Проверяем подключение клиента
  4. Пытаемся вступить в группу

### 3. Успешное вступление
- Сохраняем в БД: `status='active'`, `can_post=True`, `joined_at=NOW()`
- **Пауза:** 300-600 секунд (5-10 минут) перед следующей группой
- Продолжаем цикл

### 4. Обработка FloodWait

#### FloodWait ≤ 10 минут:
```
⏳ FloodWait: 300 секунд - ждем...
[Ожидание 300 секунд]
→ Пропускаем эту группу
→ Продолжаем с следующей
```

#### FloodWait > 10 минут:
```
⏳ FloodWait: 7200 секунд - СЛИШКОМ БОЛЬШОЙ, пропускаем группу (аккаунт требует отдыха)
→ Пропускаем группу БЕЗ ожидания
→ Продолжаем с следующей
```

**Важно:** Большие FloodWait не блокируют весь процесс!

### 5. Другие ошибки
- **Не найдена:** `status='inaccessible'`
- **Приватная:** `status='inaccessible'`
- **Пауза:** 60 секунд перед следующей попыткой

---

## ⏱️ Временные интервалы

| Действие | Интервал |
|----------|----------|
| Пауза между вступлениями | 300-600 сек (5-10 мин) |
| Пауза при ошибке | 60 сек |
| Пауза при FloodWait ≤10 мин | Wait seconds |
| Максимальный FloodWait для ожидания | 600 сек (10 мин) |

---

## 📊 Ожидаемые результаты

### За один слот (2 часа):
- **Вступит:** 3-5 групп
- **Время:** ~30-50 минут активной работы
- **Остальное время:** ожидание следующего слота

### За сутки (4 слота):
- **Вступит:** 12-20 групп
- **Увеличит базу:** в 3-5 раз быстрее, чем раньше

---

## 🔍 Мониторинг в логах

### Успешное вступление:
```
📋 Обработаем 5 групп из 144 (лимит: 5 за слот)
[1/5] @group1
  🚪 Вступаю в @group1 через promotion_account1...
  ✅ Вступил в @group1
  ✅ Подтверждено: можно постить в @group1
  ⏸ Пауза 7 минут перед следующим вступлением...
```

### FloodWait (малый):
```
[2/5] @group2
  🚪 Вступаю в @group2 через promotion_account1...
  ⏳ FloodWait: 300 секунд - ждем...
  [Ожидание...]
  ⏳ FloodWait для @group2, пропускаем эту группу
```

### FloodWait (большой):
```
[3/5] @group3
  🚪 Вступаю в @group3 через promotion_account1...
  ⏳ FloodWait: 7200 секунд - СЛИШКОМ БОЛЬШОЙ, пропускаем группу (аккаунт требует отдыха)
  ⏳ FloodWait для @group3, пропускаем эту группу
```

### Команда для проверки:
```bash
docker-compose logs --tail=100 account-manager | grep -E "Joined|FloodWait|Sleeping|✅|❌|📋 Обработаем"
```

---

## 🚨 Критичные индикаторы

### ✅ Нормально:
- Вступление в 3-5 групп за слот
- FloodWait ≤ 600 сек (пропускается)
- Паузы 5-10 минут между вступлениями

### ⚠️ Требует внимания:
- FloodWait на каждой 2-й группе → снизить лимит до 2
- FloodWait > 3600 сек (1 час) → аккаунт требует отдыха
- Вступило < 3 групп за слот → проверить доступность групп

### 🔴 Критично:
- FloodWait > 7200 сек (2 часа) → временно отключить аккаунт
- Аккаунт постоянно получает FloodWait → прогревать медленнее

---

*Логика реализована в: `services/account-manager/joiner.py`*
