#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ —Ç–æ–º, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º
"""

import asyncio
import asyncpg
from datetime import datetime, timezone
import os
from dotenv import load_dotenv

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
DB_HOST = os.getenv('DB_HOST', 'localhost')
DB_PORT = os.getenv('DB_PORT', '5434')
DB_NAME = os.getenv('DB_NAME', 'bali_bot')
DB_USER = os.getenv('DB_USER', 'grishkoff')
DB_PASSWORD = os.getenv('DB_PASSWORD', 'testpass')
BOT_TOKEN = os.getenv('BOT_TOKEN')

# –¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
REMINDER_MESSAGE = """
üëã –ü—Ä–∏–≤–µ—Ç!

–Ø –∑–∞–º–µ—Ç–∏–ª, —á—Ç–æ —Ç—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –≤ –±–æ—Ç–µ, –Ω–æ –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–ª –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

üéØ **–ö–∞–∫ –Ω–∞—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:**

1Ô∏è‚É£ **–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏** - –æ—Ç–ø—Ä–∞–≤—å –∫–æ–º–∞–Ω–¥—É `/start` –∏ –≤—ã–±–µ—Ä–∏ –Ω–∏—à–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –§–æ—Ç–æ–≥—Ä–∞—Ñ, –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ —Ç.–¥.)

2Ô∏è‚É£ **–ü–æ–ª—É—á–∞–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –∫–∞–∫ —Ç–æ–ª—å–∫–æ –≤ —á–∞—Ç–∞—Ö –ø–æ—è–≤–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —Ç–≤–æ–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, —è —Å—Ä–∞–∑—É –ø—Ä–∏—à–ª—é —Ç–µ–±–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!

3Ô∏è‚É£ **–£–ø—Ä–∞–≤–ª—è–π –ø–æ–¥–ø–∏—Å–∫–æ–π** - –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—É `/menu` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

üìã **–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
‚Ä¢ `/start` - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É –∏ –≤—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
‚Ä¢ `/menu` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
‚Ä¢ `/balance` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
‚Ä¢ `/help` - –ø–æ–º–æ—â—å –ø–æ –±–æ—Ç—É

‚è∞ –£ —Ç–µ–±—è –∞–∫—Ç–∏–≤–µ–Ω **—Ç—Ä–∏–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥**, –Ω–µ —É–ø—É—Å—Ç–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏!

–ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã - –ø–∏—à–∏, —è –ø–æ–º–æ–≥—É! üòä
"""

async def send_reminders():
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –Ω–∏—à"""
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ë–î
    db_dsn = f'postgresql://{DB_USER}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/{DB_NAME}'
    conn = await asyncpg.connect(db_dsn)
    
    print("üìä –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –Ω–∏—à...")
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –Ω–∏—à –∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º —Ç—Ä–∏–∞–ª–æ–º
    now = datetime.now(timezone.utc)
    users = await conn.fetch('''
        SELECT user_id, trial_until, subscription_active 
        FROM subscribers 
        WHERE categories = '[]' 
        AND user_id != 210147380
        AND (trial_until > $1 OR subscription_active = TRUE)
        ORDER BY user_id
    ''', now)
    
    print(f"–ù–∞–π–¥–µ–Ω–æ {len(users)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –Ω–∏—à")
    
    if len(users) == 0:
        print("‚úÖ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!")
        await conn.close()
        return
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º requests –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Telegram API
    import requests
    import time
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    sent = 0
    failed = 0
    
    for user in users:
        user_id = user['user_id']
        trial_until = user['trial_until']
        
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
            url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π
            keyboard = {
                "inline_keyboard": [
                    [{"text": "üéØ –í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", "callback_data": "start_setup"}]
                ]
            }
            
            # –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            data = {
                "chat_id": user_id,
                "text": REMINDER_MESSAGE,
                "parse_mode": "Markdown",
                "reply_markup": keyboard
            }
            
            response = requests.post(url, json=data, timeout=10)
            
            if response.status_code == 200:
                sent += 1
                
                if trial_until:
                    days_left = (trial_until - now).days
                    print(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} (—Ç—Ä–∏–∞–ª: {days_left} –¥–Ω–µ–π)")
                else:
                    print(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} (–∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞)")
            else:
                failed += 1
                print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {response.text}")
            
            # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏
            time.sleep(0.5)
            
        except Exception as e:
            failed += 1
            print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
    
    print()
    print("=" * 60)
    print(f"üìä –ò—Ç–æ–≥–æ:")
    print(f"  ‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}")
    print(f"  ‚ùå –û—à–∏–±–æ–∫: {failed}")
    print("=" * 60)
    
    await conn.close()

if __name__ == "__main__":
    print("ü§ñ –°–∫—Ä–∏–ø—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
    print("=" * 60)
    asyncio.run(send_reminders())

