import logging
import json
import os
from openai import AsyncOpenAI

logger = logging.getLogger(__name__)

class GPTJudge:
    """
    GPT-4o-mini —Å—É–¥—å—è: —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–¥–æ–≤ –ø–æ—Å–ª–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞.
    """
    def __init__(self, api_key: str = None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GPT Judge.
        
        Args:
            api_key: OpenAI API –∫–ª—é—á. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENAI_API_KEY.
        """
        self.api_key = api_key or os.getenv("OPENAI_API_KEY")
        if not self.api_key:
            logger.warning("‚ö†Ô∏è OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω. GPT Judge –±—É–¥–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω.")
            self.client = None
        else:
            self.client = AsyncOpenAI(api_key=self.api_key)
            logger.info("ü§ñ GPT Judge –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

    async def check_lead(self, text: str, niche: str):
        """
        –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É GPT: "–≠—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è –Ω–∏—à–∏ {niche}?"
        
        Args:
            text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            niche: –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∏—à–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å (–°–ø—Ä–æ—Å)", "–ê—Ä–µ–Ω–¥–∞ –±–∞–π–∫–æ–≤")
            
        Returns:
            dict: {
                'is_lead': bool,  # True, –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π –ª–∏–¥
                'reason': str     # –ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è
            }
        """
        if not self.client:
            # –ï—Å–ª–∏ GPT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ª—É—á—à–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, —á–µ–º –ø–æ—Ç–µ—Ä—è—Ç—å –ª–∏–¥
            logger.warning("‚ö†Ô∏è GPT Judge –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ—Ç API –∫–ª—é—á–∞), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É")
            return {"is_lead": False, "reason": "gpt_unavailable"}
        
        # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –Ω–∏—à
        if "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ" in niche:
            role_desc = "–ê–≤—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –ü–†–ï–î–õ–ê–ì–ê–ï–¢ —É—Å–ª—É–≥—É/—Ç–æ–≤–∞—Ä (–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫, –†–∏–µ–ª—Ç–æ—Ä)."
            target_desc = "–ü–†–ï–î–õ–ê–ì–ê–ï–¢ —Å–≤–æ—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å (—Å–¥–∞–µ—Ç, –ø—Ä–æ–¥–∞–µ—Ç)."
            negative_desc = "–ò–©–ï–¢ –∂–∏–ª—å–µ (—Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç '–∫—Ç–æ —Å–¥–∞–µ—Ç?')."
        else:
            role_desc = "–ê–≤—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –ò–©–ï–¢ —É—Å–ª—É–≥—É/—Ç–æ–≤–∞—Ä (–ö–ª–∏–µ–Ω—Ç, –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä)."
            target_desc = "–ò–©–ï–¢ —É—Å–ª—É–≥—É –∏–ª–∏ —Ç–æ–≤–∞—Ä (—Ö–æ—á–µ—Ç –∫—É–ø–∏—Ç—å, —Å–Ω—è—Ç—å, –∑–∞–∫–∞–∑–∞—Ç—å)."
            negative_desc = "–ü–†–ï–î–õ–ê–ì–ê–ï–¢ —É—Å–ª—É–≥–∏ (—Ä–µ–∫–ª–∞–º–∞, '—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ', '—Å–¥–∞—é –∫–≤–∞—Ä—Ç–∏—Ä—É')."

        prompt = f"""
–¢–≤–æ—è —Ä–æ–ª—å: –§–∏–ª—å—Ç—Ä –ª–∏–¥–æ–≤ –≤ Telegram.
–ù–∏—à–∞: "{niche}".
–¶–µ–ª—å: –ù–∞–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –≥–¥–µ {role_desc}

–ö–†–ò–¢–ï–†–ò–ò –ò–°–¢–ò–ù–´:
‚úÖ TRUE (–ü–æ–¥—Ö–æ–¥–∏—Ç): {target_desc}
‚ùå FALSE (–ú—É—Å–æ—Ä): {negative_desc}
–ò–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–ø–∞–º/–Ω–æ–≤–æ—Å—Ç–∏/—Ä–∞–±–æ—Ç–∞/–±–æ–ª—Ç–æ–≤–Ω—è.

–°–æ–æ–±—â–µ–Ω–∏–µ:
"{text}"

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
1. –ï—Å–ª–∏ —ç—Ç–æ –°–ü–ê–ú (–∫–∞–∑–∏–Ω–æ, –∫—Ä–∏–ø—Ç–∞, –≤–∞–∫–∞–Ω—Å–∏–∏, —Ä–∞–±–æ—Ç–∞, –∏–Ω—Ñ–æ–±–∏–∑–Ω–µ—Å) -> FALSE.
2. –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –±–æ–ª—Ç–æ–≤–Ω—è, –Ω–æ–≤–æ—Å—Ç–∏, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–±–æ–∫/–ø–æ–≥–æ–¥—ã -> FALSE.
3. –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–∫–ª–∞–º–∞ –±–æ—Ç–æ–≤/–∫–∞–Ω–∞–ª–æ–≤ -> FALSE.
4. –ï—Å–ª–∏ —Å–º—ã—Å–ª —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ü–µ–ª—å—é -> TRUE.

–í–µ—Ä–Ω–∏ JSON: {{"is_lead": true/false, "reason": "–∫–æ—Ä–æ—Ç–∫–æ –ø–æ—á–µ–º—É"}}
"""

        try:
            response = await self.client.chat.completions.create(
                model="gpt-4o-mini",  # –î–µ—à–µ–≤–∞—è –∏ —É–º–Ω–∞—è –º–æ–¥–µ–ª—å
                messages=[{"role": "user", "content": prompt}],
                response_format={"type": "json_object"},
                temperature=0.0  # –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
            )
            result = json.loads(response.choices[0].message.content)
            return result
        except Exception as e:
            logger.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ GPT Judge: {e}")
            # –ï—Å–ª–∏ GPT —Å–ª–æ–º–∞–ª—Å—è, –ª—É—á—à–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, —á–µ–º –ø–æ—Ç–µ—Ä—è—Ç—å –ª–∏–¥
            return {"is_lead": False, "reason": f"gpt_error: {str(e)}"}
