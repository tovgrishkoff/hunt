import numpy as np
import re
from sentence_transformers import SentenceTransformer, util
import logging

logger = logging.getLogger(__name__)

class SemanticSniper:
    def __init__(self, model_name='cointegrated/rubert-tiny2', threshold=0.55):
        """
        AI –°–Ω–∞–π–ø–µ—Ä: –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ + –§–∏–ª—å—Ç—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏–π.
        
        Args:
            model_name: –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ sentence-transformers
            threshold (0.0 - 1.0): –ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏. 
                0.5 = –º—è–≥–∫–∏–π –ø–æ–∏—Å–∫, 0.7 = –æ—á–µ–Ω—å —Ç–æ—á–Ω—ã–π –ø–æ–∏—Å–∫.
                0.55 = –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è rubert-tiny2
        """
        logger.info("üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AI –°–Ω–∞–π–ø–µ—Ä–∞...")
        try:
            self.model = SentenceTransformer(model_name)
            self.threshold = threshold
            self.anchors = {}
            self.anchor_embeddings = {}
            
            # –†–µ–≥—É–ª—è—Ä–∫–∏ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ (Supply)
            self.seller_patterns = [
                r'–ø—Ä–µ–¥–ª–∞–≥–∞—é', r'–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é', r'–æ–∫–∞–∑—ã–≤–∞—é', r'—É—Å–ª—É–≥–∏',
                r'–ø–∏—à–∏—Ç–µ\s+–≤\s+–ª—Å', r'–∑–∞\s+–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏', r'–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ',
                r'–Ω–∞—à\s+–∫–∞–Ω–∞–ª', r'–ø–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å', r'—Å—Ç–∞–∂\s+—Ä–∞–±–æ—Ç—ã',
                r'–æ–ø—ã—Ç\s+—Ä–∞–±–æ—Ç—ã', r'–∫–µ–π—Å—ã', r'—Å–≤–æ–±–æ–¥–Ω—ã–µ\s+–æ–∫–æ—à–∫–∏',
                r'–¥–µ–ª–∞—é\s+–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ', r'–æ–±—É—á–∞—é', r'–∫—É—Ä—Å—ã',
                r'–∑–∞–ø–∏—Å—å\s+–Ω–∞', r'–ø—Ä–∏–≥–ª–∞—à–∞—é', r'–º–æ–≥—É\s+—Å–¥–µ–ª–∞—Ç—å'
            ]
            
            self._load_anchors()
            logger.info(f"‚úÖ AI –°–Ω–∞–π–ø–µ—Ä –∑–∞—Ä—è–∂–µ–Ω. –ù–∏—à: {len(self.anchors)}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ AI –°–Ω–∞–π–ø–µ—Ä–∞: {e}")
            raise

    def _load_anchors(self):
        """
        –ó–∞–≥—Ä—É–∑–∫–∞ —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑ (–ë–æ–ª–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤).
        –í–∞–∂–Ω–æ: –ø–∏—à–µ–º —Ñ—Ä–∞–∑—ã —Ç–∞–∫, –∫–∞–∫ –∏—Ö –ø–∏—à–µ—Ç –ö–õ–ò–ï–ù–¢, –∞ –Ω–µ –ø—Ä–æ–¥–∞–≤–µ—Ü!
        """
        self.anchors = {
            "–§–æ—Ç–æ–≥—Ä–∞—Ñ": [
                "–Ω—É–∂–µ–Ω —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ", "–∏—â—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞", "–∫—Ç–æ –º–æ–∂–µ—Ç –ø–æ—Ñ–æ—Ç–∫–∞—Ç—å", 
                "–Ω—É–∂–Ω–∞ —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—è", "–∏—â—É —á–µ–ª–æ–≤–µ–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ", "—Å–≤–∞–¥–µ–±–Ω—ã–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ –Ω—É–∂–µ–Ω"
            ],
            "–í–∏–¥–µ–æ–≥—Ä–∞—Ñ": [
                "–Ω—É–∂–µ–Ω –≤–∏–¥–µ–æ–≥—Ä–∞—Ñ", "–∫—Ç–æ —Å–Ω–∏–º–∞–µ—Ç —Ä–∏–ª—Å", "–∏—â—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞", 
                "–º–æ–Ω—Ç–∞–∂ –≤–∏–¥–µ–æ –Ω—É–∂–µ–Ω", "–Ω—É–∂–Ω–æ —Å–Ω—è—Ç—å —Ä–æ–ª–∏–∫"
            ],
            # --- –ù–ò–®–ê 1: –ê–†–ï–ù–î–ê–¢–û–†–´ (–¢–µ, –∫—Ç–æ –∏—â–µ—Ç –∂–∏–ª—å–µ) ---
            "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å (–°–ø—Ä–æ—Å)": [
                "—Å–Ω–∏–º—É –∫–≤–∞—Ä—Ç–∏—Ä—É", 
                "—Å–Ω–∏–º—É –≤–∏–ª–ª—É",
                "—Å–Ω–∏–º—É –∫–æ–º–Ω–∞—Ç—É",
                "–∏—â—É –∂–∏–ª—å–µ –≤ –∞—Ä–µ–Ω–¥—É", 
                "–∞—Ä–µ–Ω–¥—É—é –∫–æ–º–Ω–∞—Ç—É", 
                "–Ω—É–∂–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞ –º–µ—Å—è—Ü", 
                "—Å–Ω—è—Ç—å –≤–∏–ª–ª—É",
                "—Å–Ω—è—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É",
                "–∏—â—É –¥–æ–º –Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ä–æ–∫",
                "–∫—É–ø–ª—é –∫–≤–∞—Ä—Ç–∏—Ä—É",
                "–∏—â—É –∫–≤–∞—Ä—Ç–∏—Ä—É –¥–ª—è –∞—Ä–µ–Ω–¥—ã",
                "–Ω—É–∂–Ω–∞ –≤–∏–ª–ª–∞ –≤ –∞—Ä–µ–Ω–¥—É",
                "–∏—â—É –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ –∞—Ä–µ–Ω–¥—É",
                "–Ω—É–∂–Ω–æ —Å–Ω—è—Ç—å –∂–∏–ª—å–µ",
                "–∏—â—É –∂–∏–ª—å–µ",
                "–Ω—É–∂–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞"
            ],
            # --- –ù–ò–®–ê 2: –°–û–ë–°–¢–í–ï–ù–ù–ò–ö–ò (–¢–µ, –∫—Ç–æ —Å–¥–∞–µ—Ç —Å–≤–æ–µ) ---
            "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å (–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)": [
                "—Å–¥–∞–º –∫–≤–∞—Ä—Ç–∏—Ä—É", 
                "—Å–¥–∞—é –∫–≤–∞—Ä—Ç–∏—Ä—É",
                "—Å–¥–∞—é –≤–∏–ª–ª—É", 
                "—Å–¥–∞–µ—Ç—Å—è –∫–æ–º–Ω–∞—Ç–∞", 
                "—Å–¥–∞–µ—Ç—Å—è –∫–≤–∞—Ä—Ç–∏—Ä–∞",
                "—Å–¥–∞–µ—Ç—Å—è –≤–∏–ª–ª–∞",
                "–æ—Å–≤–æ–±–æ–¥–∏–ª–∞—Å—å –≤–∏–ª–ª–∞", 
                "–ø—Ä–µ–¥–ª–∞–≥–∞—é –∂–∏–ª—å–µ",
                "—Å–¥–∞—á–∞ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤",
                "—Å–¥–∞–¥–∏–º –¥–æ–º",
                "–ø—Ä–æ–¥–∞–º –∫–≤–∞—Ä—Ç–∏—Ä—É",
                "available for rent",
                "—Å–¥–∞—é –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã",
                "—Å–¥–∞—é –≤ –∞—Ä–µ–Ω–¥—É",
                "—Å–¥–∞–µ—Ç—Å—è –≤ –∞—Ä–µ–Ω–¥—É",
                "—Å–¥–∞—é –∂–∏–ª—å–µ"
            ],
            "–ú–∞–Ω–∏–∫—é—Ä": [
                "–Ω—É–∂–µ–Ω –º–∞—Å—Ç–µ—Ä –º–∞–Ω–∏–∫—é—Ä–∞", "–∏—â—É –≥–¥–µ —Å–¥–µ–ª–∞—Ç—å –Ω–æ–≥—Ç–∏", "–Ω—É–∂–µ–Ω –º–∞–Ω–∏–∫—é—Ä"
            ],
            "–í–æ–ª–æ—Å—ã": [
                "–Ω—É–∂–µ–Ω –ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä", "–∏—â—É –º–∞—Å—Ç–µ—Ä–∞ –ø–æ –≤–æ–ª–æ—Å–∞–º", "–Ω—É–∂–Ω–∞ —Å—Ç—Ä–∏–∂–∫–∞", "–ø–æ–∫—Ä–∞—Å–∏—Ç—å –≤–æ–ª–æ—Å—ã"
            ],
            "–ê—Ä–µ–Ω–¥–∞ –∞–≤—Ç–æ": [
                # –°–ü–†–û–° (–∫–ª–∏–µ–Ω—Ç—ã –∏—â—É—Ç –º–∞—à–∏–Ω—É –≤ –∞—Ä–µ–Ω–¥—É)
                "–Ω—É–∂–Ω–∞ –º–∞—à–∏–Ω–∞ –≤ –∞—Ä–µ–Ω–¥—É", "–∞—Ä–µ–Ω–¥—É—é –∞–≤—Ç–æ", "–∏—â—É —Ç–∞—á–∫—É –Ω–∞ –ø—Ä–æ–∫–∞—Ç",
                "–Ω—É–∂–Ω–∞ –º–∞—à–∏–Ω–∞ –Ω–∞ –ø—Ä–æ–∫–∞—Ç", "—Å–Ω—è—Ç—å –º–∞—à–∏–Ω—É", "–∞—Ä–µ–Ω–¥—É—é –∞–≤—Ç–æ–º–æ–±–∏–ª—å",
                # –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï (–≤–ª–∞–¥–µ–ª—å—Ü—ã —Å–¥–∞—é—Ç –º–∞—à–∏–Ω—É –≤ –∞—Ä–µ–Ω–¥—É)
                "—Å–¥–∞—é –º–∞—à–∏–Ω—É –≤ –∞—Ä–µ–Ω–¥—É", "—Å–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ", "–ø—Ä–æ–∫–∞—Ç –º–∞—à–∏–Ω—ã",
                "—Å–¥–∞—é –∞–≤—Ç–æ–º–æ–±–∏–ª—å", "–∞—Ä–µ–Ω–¥–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è", "rent car",
                "—Å–¥–∞—é –º–∞—à–∏–Ω—É", "–ø—Ä–æ–∫–∞—Ç –∞–≤—Ç–æ"
            ],
            "–†–µ—Å–Ω–∏—á–∫–∏": [
                "–Ω—É–∂–µ–Ω –º–∞—Å—Ç–µ—Ä –ø–æ —Ä–µ—Å–Ω–∏—Ü–∞–º", "–Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ —Ä–µ—Å–Ω–∏—Ü –∏—â—É"
            ],
            "–ë—Ä–æ–≤–∏": [
                "–Ω—É–∂–µ–Ω –±—Ä–æ–≤–∏—Å—Ç", "–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –±—Ä–æ–≤–µ–π –∏—â—É"
            ],
            "–ú–∞–∫–∏—è–∂": [
                "–Ω—É–∂–µ–Ω –≤–∏–∑–∞–∂–∏—Å—Ç", "–º–∞–∫–∏—è–∂ –Ω–∞ —Å–≤–∞–¥—å–±—É –∏—â—É"
            ],
            "–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è": [
                "–Ω—É–∂–µ–Ω –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥", "—á–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞ –∏—â—É"
            ],
            "–ê—Ä–µ–Ω–¥–∞ –±–∞–π–∫–æ–≤": [
                "—Å–Ω—è—Ç—å –±–∞–π–∫", "–∞—Ä–µ–Ω–¥–∞ —Å–∫—É—Ç–µ—Ä–∞", "–Ω—É–∂–µ–Ω nmax –≤ –∞—Ä–µ–Ω–¥—É", "–∏—â—É –±–∞–π–∫"
            ],
            "–û–±–º–µ–Ω –≤–∞–ª—é—Ç": [
                "–ø–æ–º–µ–Ω—è—Ç—å —Ä—É–±–ª–∏ –Ω–∞ –¥–∏—Ä—Ö–∞–º—ã", "–æ–±–º–µ–Ω—è—Ç—å usdt –Ω–∞ –∫—ç—à", "–æ–±–º–µ–Ω –≤–∞–ª—é—Ç—ã –Ω—É–∂–µ–Ω"
            ],
            "–ö–∞–ª—å—è–Ω—ã": [
                "–∑–∞–∫–∞–∑–∞—Ç—å –∫–∞–ª—å—è–Ω –Ω–∞ –¥–æ–º", "–¥–æ—Å—Ç–∞–≤–∫–∞ –∫–∞–ª—å—è–Ω–∞", "–∞—Ä–µ–Ω–¥–∞ –∫–∞–ª—å—è–Ω–∞"
            ],
            "–ê—Ä–µ–Ω–¥–∞ Playstation": [
                "–∞—Ä–µ–Ω–¥–∞ ps5", "–≤–∑—è—Ç—å –ø–ª–æ–π–∫—É –≤ –∞—Ä–µ–Ω–¥—É", "–ø—Ä–æ–∫–∞—Ç playstation"
            ],
            "–ú–µ–¥–∏–∞-—Å—Ç—É–¥–∏—è": [
                "–∞—Ä–µ–Ω–¥–∞ —Ñ–æ—Ç–æ—Å—Ç—É–¥–∏–∏", "—Å—Ç—É–¥–∏—è –¥–ª—è –ø–æ–¥–∫–∞—Å—Ç–∞", "—Å–Ω—è—Ç—å —Å—Ç—É–¥–∏—é"
            ],
            "–¢—É—Ä–∏–∑–º": [
                "–Ω—É–∂–µ–Ω –≥–∏–¥", "–∏—â—É —ç–∫—Å–∫—É—Ä—Å–∏—é", "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä —Ç—É—Ä–æ–≤ –Ω—É–∂–µ–Ω"
            ],
            "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç": [
                "–Ω—É–∂–Ω–æ —Ç–∞–∫—Å–∏", "—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç", "–∏—â—É –≤–æ–¥–∏—Ç–µ–ª—è"
            ]
        }
        
        # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
        logger.info(f"üìù –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —ç—Ç–∞–ª–æ–Ω–æ–≤ –¥–ª—è {len(self.anchors)} –Ω–∏—à...")
        for niche, phrases in self.anchors.items():
            if phrases:
                try:
                    self.anchor_embeddings[niche] = self.model.encode(phrases, convert_to_numpy=True)
                    logger.debug(f"‚úÖ –≠—Ç–∞–ª–æ–Ω—ã –¥–ª—è '{niche}': {len(phrases)} —Ñ—Ä–∞–∑")
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è '{niche}': {e}")
                    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç—Ç–∞–ª–æ–Ω—ã –¥–ª—è –Ω–∏—à–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—ë
                    continue
        
        total_phrases = sum(len(phrases) for phrases in self.anchors.values())
        logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {total_phrases} —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑ –¥–ª—è {len(self.anchor_embeddings)} –Ω–∏—à")

    def is_seller(self, text: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞: –ø–æ—Ö–æ–∂ –ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É—Å–ª—É–≥ (–ø—Ä–æ–¥–∞–≤–µ—Ü).
        
        Args:
            text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            
        Returns:
            bool: True, –µ—Å–ª–∏ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É—Å–ª—É–≥ (–ø—Ä–æ–¥–∞–≤–µ—Ü)
        """
        if not text:
            return False
            
        text_lower = text.lower()
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —è–≤–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–¥–∞–≤—Ü–∞
        for pattern in self.seller_patterns:
            if re.search(pattern, text_lower):
                # –ù–û: –ï—Å–ª–∏ –µ—Å—Ç—å —è–≤–Ω–æ–µ "–ò–©–£" —Ä—è–¥–æ–º, –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ —Å–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                # –ü–æ–∫–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–¥–∞–≤—Ü–æ–º, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å
                return True
                
        return False

    def analyze(self, text: str):
        """
        –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è: –ø–æ–∏—Å–∫ –Ω–∏—à–∏ —á–µ—Ä–µ–∑ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫.
        –≠—Ç–æ —á–µ—Ä–Ω–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –≤ GPT Judge.
        
        Args:
            text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            
        Returns: 
            dict: {
                'is_lead': bool,       # True, –µ—Å–ª–∏ —ç—Ç–æ –ö–ê–ù–î–ò–î–ê–¢ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ GPT
                'niche': str or None,  # –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∏—à–∏ (–µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞)
                'score': float,        # –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (0-100)
                'reason': str          # –ü—Ä–∏—á–∏–Ω–∞ —Ä–µ—à–µ–Ω–∏—è (–¥–ª—è –ª–æ–≥–æ–≤)
            }
        """
        if not text:
            return {'is_lead': False, 'niche': None, 'score': 0, 'reason': 'empty_text'}
        
        text_lower = text.lower()
        
        # 1. –≠–ö–û–ù–û–ú–ò–Ø –î–ï–ù–ï–ì:
        # –ù–µ —à–ª–µ–º –≤ GPT —è–≤–Ω—ã–π –º—É—Å–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∏ —Ç–∞–∫ –ø–æ–Ω—è—Ç–µ–Ω.
        # –≠—Ç–æ —Å—ç–∫–æ–Ω–æ–º–∏—Ç –≤–∞–º 50% –±—é–¥–∂–µ—Ç–∞ API.
        hard_spam = ['usdt', '–≤–∞–∫–∞–Ω—Å–∏—è', '–º–µ–Ω–µ–¥–∂–µ—Ä', '–Ω–∞–±–æ—Ä', '–∑–∞—Ä–∞–±–æ—Ç–æ–∫', 'bot', '–ø–æ–¥–ø–∏—à–∏—Å—å']
        if any(w in text_lower for w in hard_spam):
            return {'is_lead': False, 'niche': None, 'score': 0, 'reason': 'hard_spam'}

        try:
            # 2. –í–ï–ö–¢–û–†–ù–´–ô –ü–û–ò–°–ö (–ö–∞–∫ –±—ã–ª–æ)
            msg_embedding = self.model.encode(text, convert_to_numpy=True)
            best_niche = None
            max_score = 0
            
            for niche, anchor_embs in self.anchor_embeddings.items():
                scores = util.cos_sim(msg_embedding, anchor_embs)[0]
                # util.cos_sim –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç torch.Tensor, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ numpy –¥–ª—è np.max
                if hasattr(scores, 'cpu'):  # –≠—Ç–æ torch.Tensor
                    scores_np = scores.cpu().numpy()
                else:  # –≠—Ç–æ —É–∂–µ numpy array
                    scores_np = scores
                current_max = float(np.max(scores_np))
                
                if current_max > max_score:
                    max_score = current_max
                    best_niche = niche

            # 3. –ü–û–†–û–ì
            # –°—Ç–∞–≤–∏–º 0.60 (60%).
            # –í—Å—ë —á—Ç–æ –Ω–∏–∂–µ - —Ç–æ—á–Ω–æ –º—É—Å–æ—Ä. –í—Å—ë —á—Ç–æ –≤—ã—à–µ - –ø—Ä–æ–≤–µ—Ä–∏—Ç GPT.
            if max_score < 0.60:
                return {
                    'is_lead': False,
                    'niche': None,
                    'score': round(max_score * 100, 1),
                    'reason': 'low_score'
                }

            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º "–ö–∞–Ω–¥–∏–¥–∞—Ç–∞" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ GPT
            return {
                'is_lead': True,  # –≠—Ç–æ –ø–æ–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ "–î–∞"
                'niche': best_niche,
                'score': round(max_score * 100, 1),
                'reason': 'candidate_for_gpt'
            }
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ analyze: {e}")
            return {'is_lead': False, 'niche': None, 'score': 0, 'reason': f'error: {str(e)}'}
