# ‚úÖ Smart Joiner - –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## üìã –û–±–∑–æ—Ä

–ú–æ–¥—É–ª—å **Smart Joiner** –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ –¢–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –≤–∫–ª—é—á–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é.

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ‚úÖ
- ‚úÖ –ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ (–≤—ã–±–æ—Ä–∫–∞ 5 –≥—Ä—É–ø–ø —Å–æ `status='new'`)
- ‚úÖ –í—ã–±–æ—Ä –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏–∑ –ë–î
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ TelegramClient —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä–æ–∫—Å–∏
- ‚úÖ –°—Ç—Ä–æ–≥–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –≥—Ä—É–ø–ø—ã –∫ –∞–∫–∫–∞—É–Ω—Ç—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
- ‚úÖ Warm-up –ø–µ—Ä–∏–æ–¥ 24 —á–∞—Å–∞

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ FloodWait ‚úÖ
- ‚úÖ **‚â§600 —Å–µ–∫ (10 –º–∏–Ω)**: –ñ–¥–µ–º –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≥—Ä—É–ø–ø—É
- ‚úÖ **>600 —Å–µ–∫**: –ü–æ–º–µ—á–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç –∫–∞–∫ `cooldown`, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π –∞–∫–∫–∞—É–Ω—Ç
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `next_allowed_action_time` –≤ –ë–î

### 3. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∏–ø–æ–≤ –≥—Ä—É–ø–ø ‚úÖ
- ‚úÖ **–ü—É–±–ª–∏—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã**: `JoinChannelRequest` –¥–ª—è `@username`
- ‚úÖ **–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã**: `ImportChatInviteRequest` –¥–ª—è `t.me/+hash` –∏–ª–∏ `t.me/joinchat/hash`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å—Å—ã–ª–∫–∏

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ‚úÖ
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≥—Ä—É–ø–ø—ã –Ω–∞ `error` —Å `error_message`
- ‚úÖ –ü–∞—É–∑—ã: 5-10 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞, 60 —Å–µ–∫ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ë–î ‚úÖ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `lexus_db.models` (Account, Target)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `lexus_db.db_manager.DbManager.assign_group()`
- ‚úÖ Async SQLAlchemy —Å–µ—Å—Å–∏–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `cooldown` –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤

## üì¶ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`services/account-manager/smart_joiner.py`** (451 —Å—Ç—Ä–æ–∫–∞)
   - –ö–ª–∞—Å—Å `SmartJoiner`
   - –ú–µ—Ç–æ–¥ `run_batch()`
   - –ü–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

2. **`lexus_db/models.py`** (–æ–±–Ω–æ–≤–ª–µ–Ω)
   - –ü–æ–ª–µ `error_message` –≤ —Ç–∞–±–ª–∏—Ü–µ `Target`
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `cooldown` –¥–ª—è Account

3. **`SMART_JOINER_GUIDE.md`**
   - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –û–ø–∏—Å–∞–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–∞—Ä—Å–µ—Ä –ø—Ä–æ–∫—Å–∏ ‚úÖ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `_parse_proxy()` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
- `socks5://user:pass@host:port`
- `http://user:pass@host:port`

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø ‚úÖ
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞:
- `t.me/+AbCdEfGhIjKlMnOpQrStUvWxYz`
- `t.me/joinchat/AbCdEfGhIjKlMnOpQrStUvWxYz`

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç `CheckChatInviteRequest` –∏ `ImportChatInviteRequest`.

### DbManager.assign_group() ‚úÖ
–ú–µ—Ç–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `lexus_db/db_manager.py`:
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –≥—Ä—É–ø–ø—É
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –ª–∏ –≥—Ä—É–ø–ø–∞ –∫ –¥—Ä—É–≥–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `assigned_account_id`, `joined_at`, `warmup_ends_at`
- –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from services.account-manager.smart_joiner import SmartJoiner
import asyncio

async def main():
    joiner = SmartJoiner()
    await joiner.run_batch(niche='ukraine_cars', batch_size=5)

asyncio.run(main())
```

–ò–ª–∏ –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏:
```bash
python3 services/account-manager/smart_joiner.py ukraine_cars 5
```

## üìä SQL –º–∏–≥—Ä–∞—Ü–∏—è

–ü–æ–ª–µ `error_message` —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–æ–¥–µ–ª—å `Target` —á–µ—Ä–µ–∑ SQLAlchemy. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é:

```sql
ALTER TABLE targets 
ADD COLUMN IF NOT EXISTS error_message TEXT;
```

–û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è (`assigned_account_id`, `joined_at`, `warmup_ends_at`) —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –º–æ–¥–µ–ª–∏.

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–û–¥–∏–Ω –∑–∞–ø—É—Å–∫ = –æ–¥–∏–Ω –±–∞—Ç—á**: –°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–∞—Ç—á –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è (–¥–ª—è Cron/Docker)
2. **–°—Ç—Ä–æ–≥–∞—è –ø—Ä–∏–≤—è–∑–∫–∞**: –ì—Ä—É–ø–ø–∞ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –∞–∫–∫–∞—É–Ω—Ç—É –Ω–∞–≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
3. **Warm-up**: –ü–æ—Å–ª–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –ø–æ—Å—Ç–∏–Ω–≥–∞ 24 —á–∞—Å–∞
4. **FloodWait >600 —Å–µ–∫**: –ê–∫–∫–∞—É–Ω—Ç –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ `cooldown` –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–æ `next_allowed_action_time`

## ‚úÖ –í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

- ‚úÖ –ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ –í—ã–±–æ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ FloodWait (‚â§600 vs >600)
- ‚úÖ –°—Ç—Ä–æ–≥–∞—è –ø—Ä–∏–≤—è–∑–∫–∞
- ‚úÖ Warm-up 24 —á–∞—Å–∞
- ‚úÖ –ü–∞—É–∑—ã –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è)
- ‚úÖ –ü–∞—Ä—Å–µ—Ä –ø—Ä–æ–∫—Å–∏
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DbManager

**–°—Ç–∞—Ç—É—Å: –ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ** üéâ
